<!doctype html>
<html>
<head>
<title>ankabuta</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&family=Noto+Color+Emoji&display=swap" rel="stylesheet">
<style>
* { font-size:11pt; font-family:'Roboto', 'Noto Color Emoji', sans-serif; margin:0; box-sizing:border-box; tab-size:4; }
textarea:focus, input:focus { outline:1px solid #000; outline-offset:-2px; }
textarea:disabled, input:disabled { border-color:#555; background:#ccc; }
textarea, input { border:1px solid #000; border-radius:3px; }
#rooms, #log, #sidebar, #leave, #run, #codebox, iframe { display:none; }
.joined #log, .joined #sidebar, .joined #leave { display:block; }
.joined #rooms { width:150px; }
.joined #roomform { margin:0 0 3px 0; }
.joined a { display:block; padding:6px; padding-left:6px; text-indent:-6px; }
.admin #codebox, .admin #run { display:block; }

#wrapper { display:flex; padding:1px; position:fixed; width:100%; height:calc(100% - 50px); }
#wrapper > * { padding:5px; margin:1px 1px 0 1px; }
#wrapper > *:not(#codebox) { white-space:pre-wrap; word-break:break-word; overflow-y:auto; }
#codebox { font:9pt monospace; width:300px; resize:horizontal; white-space:pre; }
#log { flex-grow:1; }
#wrapper > *:not(#log) { flex-shrink:0 }
.sysmsg { text-shadow:1px 1px 2px #000, 0 0 2px #000, 0 0 2px #000, 0 0 2px #000; color:#fff; }
#sidebar { width:150px; }

#rooms { width:100%; }
#roomform { display:flex; margin:15px; justify-content:center; }
#roomform > input { margin:1px; }
#room { min-width:10px; }
a { font-weight:bold; color:#09f; text-decoration:none; display:inline-block; margin:2px; line-height:12px; padding:15px; }
a:hover { color:#f55; }
a.myroom { color:#000 !important; cursor:default; }

#msgform { padding:1px; bottom:0; position:fixed; width:100%; height:50px; display:flex; }
#msgform > * { margin:0 1px 1px 1px; }
#msgform > input { width:80px; }
#msgbox { flex-grow:1; resize:none; padding:5px; }
</style>
</head>
<body>
<div id="wrapper">
<div id="rooms"><form id="roomform"><input type="text" id="room" autofocus><input type="submit" id="go" value="Go"></form></div>
<textarea id="codebox" spellcheck="false"></textarea>
<div id="log" role="log"></div>
<div id="sidebar" role="log"></div>
</div>
<form id="msgform">
<input type="button" id="leave" value="Leave">
<input type="button" id="run" value="Run">
<textarea id="msgbox"></textarea>
<input type="submit" id="say" value="Say" disabled>
</form>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
socket.once('start', (myname, rooms) => {
	const get = id => document.getElementById(id);
	let iframe;
	let interval;
	let msgcount = 0;
	const msgs = [];
	let msgindex = 0;
	if(location.hash) {
		socket.emit('join', decodeURI(location.hash));
	}
	onhashchange = () => {
		console.log(decodeURI(location.hash)); //
		socket.emit('join', decodeURI(location.hash));
	}
	socket.once('disconnect', () => {
		get('go').disabled = get('leave').disabled = get('run').disabled = get('say').disabled = true;
		const div = document.createElement('div');
		div.className = 'sysmsg';
		div.textContent = 'Connection failed!';
		if(get('log').style.display == 'block') {
			get('log').appendChild(div);
		} else {
			get('rooms').appendChild(div);
		}
		div.scrollIntoView();

//		addmsg('Connection failed!', true);
		socket.removeAllListeners();
	});
	const addroom = room => {
		const a = document.createElement('a');
		a.textContent = a.id = a.href = room;
		get('rooms').append(a);
	}
	for(const room of rooms) {
		addroom(room);
	}
	get('roomform').onsubmit = e => {
		e.preventDefault();
		const room = get('room').value;
		if(!room) return;
		get('room').value = '';
		socket.emit('join', room);
	}
	get('room').onkeydown = e => {
		if(!e.shiftKey && e.key == 'Enter') {
			e.preventDefault();
			get('go').click();
		}
	}
	socket.on('addroom', addroom);
	socket.on('rmvroom', room => get(room).remove());
	socket.on('joinroom', (room, admin) => {
		console.log('hi'); //
		get(room).className = 'myroom';
		history.replaceState(null, '', document.location.pathname+room);
		document.title = 'ankabuta'+room;
		get('say').disabled = false;
		get('msgbox').focus();
		document.body.classList.add('joined');
		get('leave').onclick = () => socket.emit('leave');
		const addmsg = (msg, sys) => {
			const div = document.createElement('div');
			if(sys) {
				div.className = 'sysmsg';
				div.textContent = msg;
			} else {
				msgcount++;
				if(!interval && document.visibilityState == 'hidden') {
					let i = 0;
					const animate = () => {
						let title = [...('ankabuta'+room)];
						title[i] = title[i].toUpperCase();
						do {
							i = (i + 1) % title.length;
						} while(title[i] == title[i].toUpperCase());
						document.title = '('+msgcount+') '+title.join('');
					};
					document.title = '('+msgcount+') ankabuta'+room;
					interval = setInterval(animate, 400);
				}
				const loop = text => {
					const match = text.match(/(^.*?)\[(#(?=[a-f0-9]{3})|[*_/-])(.+?)\2\](.*)/si);
					if(!match) return text;
					const frag = document.createDocumentFragment();
					const span = document.createElement('span');
					let hex;
					if(match[2] == '#') {
						hex = match[3].slice(0, 3);
						match[3] = match[3].slice(3);
					}
					span.style = { '#':'color:#'+hex, '*':'font-weight:bold', '_':'text-decoration:underline', '/':'font-style:italic', '-':'text-decoration:line-through' }[match[2]];
					span.append(loop(match[3]));
					frag.append(loop(match[1]), span, loop(match[4]));
					return frag;
				}
				div.append(loop(msg));
			}
			get('log').appendChild(div);
			div.scrollIntoView();
		}
		const stopanimation = () => {
			if(document.visibilityState == 'hidden' || !interval) return;
			interval = clearInterval(interval);
			document.title = 'ankabuta'+room;
			msgcount = 0;
		}
		document.addEventListener('visibilitychange', stopanimation);
		const change = (id, text) => {
			if(id == '' || id == null) {
				get('sidebar').textContent = '';
				return;
			}
			if(text == null) {
				get(id)?.remove();
				return;
			}
			id = 'div'+id;
			const div = get(id) || document.createElement('div');
			div.textContent = text;
			if(!div.parentNode) {
				div.id = id;
				get('sidebar').append(div);
			}
		}
		get('msgform').onsubmit = e => {
			e.preventDefault();
			const msg = get('msgbox').value;
			if(!msg) return;
			msgs.splice(msgindex++, Infinity, msg);
			const arr = msg.split(' ');
			const cmd = arr.shift();
			if(msg[0] == '/') addmsg(msg, true);
			if(/^\/(join|j)$/.test(cmd)) {
				socket.emit('join', arr.join(' '));
			} else if(/^\/(leave|l)$/.test(cmd)) {
				socket.emit('leave');
			} else if(/^\/(clear|c)$/.test(cmd)) {
				get('log').textContent = '';
			} else if(iframe) {
				if(/^\/(kick|k)$/.test(cmd)) {
					socket.emit('kick', arr.join(' '));
				} else {
					iframe.contentWindow.hear?.(msg, myname);
				}
			} else {
				socket.emit('say', msg);
			}
			get('msgbox').value = '';
		}
		get('msgbox').onkeydown = e => {
			if(e.ctrlKey && e.key == 'ArrowUp') {
				msgindex = Math.max(--msgindex, 0);
				get('msgbox').value = msgs[msgindex];
			} else if(e.ctrlKey && e.key == 'ArrowDown') {
				msgindex = Math.min(++msgindex, msgs.length);
				get('msgbox').value = msgs[msgindex] || '';
			} else if(!e.shiftKey && e.key == 'Enter') {
				e.preventDefault();
				get('say').click();
			}
		}
		addmsg('You have joined '+room, true);
		socket.once('leaveroom', msg => {
			console.log('bye'); //
			if(interval) {
				interval = clearInterval(interval);
				msgcount = 0;
			}
			document.title = 'ankabuta';
			document.removeEventListener('visibilitychange', stopanimation);
			const leave = () => {
				document.body.removeAttribute('class');
				get(room).removeAttribute('class');
				history.pushState(null, '', document.location.pathname);
				get('say').disabled = true;
				get('log').textContent = get('sidebar').textContent = '';
				get('room').focus();
				if(!admin) {
					socket.off('change');
					socket.off('hear');
					return;
				}
				for(const event of ['join', 'leave', 'hear']) {
					socket.off(event);
				}
				iframe.remove();
				iframe = null;
			}
			if(msg) {
				addmsg(msg, true);
				get('run').disabled = get('say').disabled = true;
				get('leave').onclick = () => leave();
				get('leave').focus();
			} else {
				leave();
			}
		});
		if(!admin) {
			socket.on('change', change);
			socket.on('hear', addmsg);
			return;
		}
		document.body.classList.add('admin');
		const persistent = { users:{ [myname]:{} } };
		get('codebox').value =
			`function join(name) {
				sendAll(name+' has joined',
					name, 'Welcome, '+name+'! Users: '+Object.keys(persistent.users).join(', '));
			}
			function leave(name) {
				sendAll(name+' has left');
			}
			function hear(msg, name) {
				const arr = msg.split(' ');
				const cmd = arr.shift();
				if(cmd == '/pm') {
					sendOnly(name+' (private): '+arr.slice(1).join(' '), arr[0]);
				} else if(cmd == '/me') {
					sendAll('* '+name+' '+arr.join(' '));
				} else {
					sendAll(name+': '+msg);
				}
			}`.replace(/^\t\t\t/gm, '');
		get('run').disabled = false;
		get('codebox').oninput = () => get('run').disabled = false;
		get('codebox').onkeydown = e => {
			if(e.ctrlKey && e.key == 's') {
				e.preventDefault();
				get('run').click();
			} else if(e.key == 'Tab') {
				e.preventDefault();
				const start = get('codebox').selectionStart;
				const end = get('codebox').selectionEnd;
				const text = get('codebox').value;
				const arr = [text.slice(0, start), text.slice(start, end), text.slice(end)];
				let num = 0;
				if(e.shiftKey) {
					arr[0] = arr[0].replace(/\n\t(?!.*\n)/, '\n');
					arr[1] = arr[1].replace(/\n\t/g, '\n');
				} else {
					if(arr[1].includes('\n')) {
						arr[0] = arr[0].replace(/\n(?!.*\n)/, '\n\t');
						arr[1] = arr[1].replace(/\n/g, '\n\t');
					} else {
						arr[1] = '\t';
						num = 1;
					}
				}
				get('codebox').value = arr.join('');
				get('codebox').selectionStart = arr[0].length + num;
				get('codebox').selectionEnd = arr[0].length + arr[1].length;
				get('run').disabled = false;
			}
		}
		iframe = document.createElement('iframe');
		let code;
		get('run').onclick = e => {
			e.preventDefault();
			get('run').disabled = true;
			iframe.src = 'about:blank';
			document.body.append(iframe);
			iframe.contentWindow.persistent = persistent;
			iframe.contentWindow.kick = name => socket.emit('kick', name);
			iframe.contentWindow.change = (id, text) => {
				change(id, text);
				socket.emit('change', id, text);
			}
			iframe.contentWindow.sendOnly = (msg1, names, msg2) => {
				if(!msg1 || !names) return;
				if(!Array.isArray(names)) {
					names = [names];
				}
				if(names.includes(myname)) {
					addmsg(msg1);
				} else if(msg2) {
					addmsg(msg2);
				}
				socket.emit('sendOnly', msg1, names, msg2);
			}
			iframe.contentWindow.sendAll = (msg1, names, msg2) => {
				if(!msg1) return;
				if(names) {
					if(!Array.isArray(names)) {
						names = [names];
					}
					if(!names.includes(myname)) {
						addmsg(msg1);
					} else if(msg2) {
						addmsg(msg2);
					}
				} else {
					addmsg(msg1);
				}
				socket.emit('sendAll', msg1, names, msg2);
			}
			for(const event of ['join', 'leave', 'hear']) {
//				iframe.contentWindow[event] = (...arr) => console.log({ 'join':arr[0]+' has joined', 'leave':arr[0]+' has left', 'hear':arr[1]+': '+arr[0] }[event]);
				socket.off(event);
			}
			socket.on('join', name => {
				iframe.contentWindow.join?.(name);
				persistent.users[name] = {};
			});
			socket.on('leave', name =>  {
				delete persistent.users[name];
				iframe.contentWindow.leave?.(name);
			});
			socket.on('hear', (msg, name) => iframe.contentWindow.hear?.(msg, name));
			try {
				iframe.contentWindow.eval(get('codebox').value);
				code = get('codebox').value;
			} catch(err) {
				console.error(err);
				addmsg(err.name+': '+err.message, true);
				iframe.contentWindow.eval(code);/*
				const arr = get('codebox').value.split('\n');
				const match = err.stack.match(/<anonymous>:(\d+):(\d+)/);
				if(match) {
					const row = match[1] - 1;
					const col = match[2] - 1;
					let index = 0;
					for(let i = 0; i < row; i++) {
						index += arr[i].length + 1; // +1 for the linebreak
					}
					get('codebox').selectionStart = get('codebox').selectionEnd = index + col;
					get('codebox').focus();
				}*/
			}
		}
		get('run').click();
	});
});
</script>
</body>
</html>