<!doctype html>
<html>
<head>
<title>ankabuta</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@600;750&family=Noto+Color+Emoji&display=swap" rel="stylesheet">
<style>
* { font-size:11pt; font-family:'Open Sans', 'Noto Color Emoji', sans-serif; margin:0; box-sizing:border-box; tab-size:4; line-height:18px; }
input::-webkit-input-placeholder { opacity: 0.5; }
textarea, input { border:1px solid #000; border-radius:3px; }
textarea:focus, input:focus { outline:1px solid #000; outline-offset:-2px; }
textarea:read-only, input[type=text]:read-only, input:disabled { border-color:#555 !important; background:#ccc; color:#888; outline:none; }
a { font-weight:bold; color:#09f; text-decoration:none; display:block; }
.joined #rooms.hidden, #codebox, #log, #sidebar, #help.hidden, #help .hidden, #leave, #run, #iframe { display:none; }
.joined #log, .joined #sidebar, .joined #leave { display:block; }
.joined #rooms { width:150px; display:block; }
.admin #help div.hidden, .admin #codebox, .admin #run { display:block; }
.admin #help span.hidden { display:inline; }

#rooms { flex-grow:1; flex-shrink:1; }
#rooms .sysmsg { text-align:center; }
#roomform { display:flex; margin:6px; justify-content:center; }
.joined #roomform { margin:0; }
#roomform > input { margin:1px; }
#room { min-width:10px; padding:0 4px; }
#rooms > a { display:inline-block; padding:10px 20px; margin:2px; line-height:12px; }
.joined #rooms > a { display:block; padding:6px; padding-left:6px; text-indent:-6px; }
a:hover { color:#f55; }
a.disabled, #rooms.disabled > a { color:#000; pointer-events:none; }

#wrapper { display:flex; position:fixed; width:100%; height:calc(100% - 50px); padding:1px 1px 0 1px; }
#wrapper > * { margin:1px; }
#wrapper > *:not(#log, #help) { padding:5px; }
#wrapper > *:not(#codebox, #help), #help div { white-space:pre-wrap; word-break:break-word; }
#wrapper > *:not(#codebox) { overflow-y:auto; }
#codebox { font:9pt monospace; width:300px; resize:horizontal; white-space:pre; }
#codebox.changed { border-color:#f00; outline-color:#f00; }
.joined #wrapper > *, #help { flex-grow:0; flex-shrink:0; }
.joined #log { flex-grow:1; flex-shrink:1; }

#log > div { margin:5px; }
.sysmsg { font-weight:bold; }
#arrow { width:100%; bottom:0; position:sticky; }
#arrow.hidden { display:none; }
@keyframes move { to { background-position:1000px 0; } }
.rainbow { animation:move 30s ease-out 1; background:linear-gradient(90deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00) 0 0/100px 100px; -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

#sidebar { width:200px; max-width:35%; }
#sidebar:empty { display:none; }
#divvideo { aspect-ratio:1; overflow-y:auto; }
#video { position:sticky; top:0; width:100%; aspect-ratio:16 / 9; }
#divvideo > a { white-space:pre; text-overflow:ellipsis; overflow:hidden; }
#sidebar a.disabled { pointer-events:auto; }

#help { padding:0 5px; line-height:13pt; }
#help p { padding:1px 0; }
#help div { margin:5px 0; }
#help b { opacity:.5; font-weight:normal; }

#msgform { bottom:0; position:fixed; width:100%; height:50px; display:flex; padding:0 1px 1px 1px; }
#msgform > * { margin:1px; }
#msgform > input { width:80px; }
#msgbox { flex-grow:1; resize:none; padding:5px; }

@media (prefers-color-scheme:dark) {
	body { background:#000; color:#fff; }
	input, textarea { background:#000; color:#fff; border-color:#ccc; }
	textarea:focus, input[type=text]:focus { outline-color:#ccc; background:#111; }
	input[type=button], input[type=submit] { background:#222; }
	input[type=button]:focus, input[type=submit]:focus { outline-color:#ccc; background:#333; }
	textarea:read-only, #room:read-only, input:disabled { background:#000; color:#444; }
	::-webkit-scrollbar { width:15px; height:15px; }
	::-webkit-scrollbar-track { background:#222; }
	::-webkit-scrollbar-thumb { background-color:#333; border:1px solid #555; }
	::-webkit-scrollbar-corner { background:#333; }
	::-webkit-resizer { border-width:8px; border-style:solid; border-color:transparent #999 #999 transparent; }
	textarea { cursor:auto; }
	a.disabled, #rooms.disabled > a { color:#fff; }
}

@media (prefers-reduced-motion:reduce) {
	.rainbow { animation:none; }
}
</style>
<meta description="Create a chatroom with your own code or join other people's rooms">
</head>
<body>
<div id="wrapper">
<div id="rooms" class="hidden"><form id="roomform"><input type="text" id="room" maxlength="29" aria-label="Room" autofocus><input type="submit" id="go" value="Go"></form></div>
<textarea id="codebox" spellcheck="false"></textarea>
<div id="log" role="log"><input type="button" id="arrow" value="⮟" class="hidden"></div>
<div id="sidebar" role="log"></div>
<div id="help" class="hidden">
<p>
<div>/clear
/join <b>ROOM</b>
/leave
<span class="hidden">/kick <b>USER</b> <b>MINUTES</b></span></div>
</p><p>
<div>ctrl+h
	<i>Toggle this help menu</i></div>
<div>ctrl+o
	<i>Show or hide the rooms</i></div>
<div>ctrl+up
	<i>Previous message<span class="hidden"> or code</span></i></div>
<div>ctrl+down
	<i>Next message<span class="hidden"> or code</span></i></div>
<div class="hidden">ctrl+s
	<i>Save and run the code</i></span></div>
</p><p>
<div class="hidden">sendOnly(<b>message1, users, message2</b>)
	<i>Sends <b>message1</b> to <b>users</b>
	and sends <b>message2</b> to everyone else</i></div>
<div class="hidden">sendAll(<b>message1, users, message2</b>)
	<i>Sends <b>message1</b> to everyone but <b>users</b>
	and sends <b>message2</b> to <b>users</b></i></div>
<div class="hidden">sendAll(true, <b>word</b>)
	<i>Adds <b>word</b> to everyone's sidebar</i></div>
<div class="hidden">sendAll(false, <b>word</b>)
	<i>Removes <b>word</b> from everyone's sidebar</i></div>
</p>
</div>
</div>
<form id="msgform">
<input type="button" id="leave" value="Leave">
<input type="button" id="run" value="Run">
<textarea id="msgbox" aria-label="Message" readonly></textarea>
<input type="submit" id="say" value="Say" disabled>
</form>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
socket.once('start', (myname, rooms) => {
	const get = id => document.getElementById(id);
	let interval;
	let msgcount = 0;
	const msghistory = [];
	let msgindex = 0;
	let lastmsg = '';
	if(location.hash) {
		socket.emit('join', decodeURI(location.hash));
	}
	onhashchange = () => {
		socket.emit('join', decodeURI(location.hash));
	}
	get('room').placeholder = myname+'\'s room';
	const addsysmsg = msg => {
		const div = document.createElement('div');
		div.className = 'sysmsg';
		div.textContent = msg;
		if(document.body.classList.contains('joined')) {
			get('arrow').before(div);
			if(get('arrow').classList.contains('hidden')) {
				div.scrollIntoView();
			}
		} else {
			document.querySelector('#rooms > div')?.remove();
			get('roomform').after(div);
		}
	}
	socket.once('disconnect', () => {
		get('room').readOnly = get('go').disabled = get('codebox').readOnly = get('run').disabled = get('msgbox').readOnly = get('say').disabled = true;
		get('leave').onclick = () => location.href = '/';
		addsysmsg('Connection failed!');
		document.title = document.title.replace(/^ankabuta#?(.*)$/, 'ankabuta☠️$1');
		socket.removeAllListeners();
		get('rooms').classList.add('disabled');
	});
	const addroom = room => {
		const a = document.createElement('a');
		a.id = a.href = room;
		a.textContent = room.includes('hidden')? '('+room+')': room;
		get('rooms').append(a);
	}
	for(const room of rooms) {
		addroom(room);
	}
	onkeydown = e => {
		if(e.ctrlKey && e.key == 'o') {
			get('rooms').classList.toggle('hidden');
		} else if(e.ctrlKey && e.key == 'h') {
			get('help').classList.toggle('hidden');
		} else if(e.ctrlKey && e.key == 's') {
			if(document.body.classList.contains('admin')) {
				get('run').click();
			}
		} else return;
		e.preventDefault();
	}
	get('roomform').onsubmit = e => {
		e.preventDefault();
		const room = get('room').value;
		if(!room) return;
		get('room').value = '';
		socket.emit('join', room);
	}
	get('room').onkeydown = e => {
		if(!e.shiftKey && e.key == 'Enter') {
			e.preventDefault();
			get('go').click();
		}
	}
	socket.on('addroom', addroom);
	socket.on('rmvroom', room => get(room).remove());
	const leave = () => {
		history.replaceState(null, '', document.location.pathname);
		document.body.classList.remove('joined', 'admin');
		const arrow = get('arrow');
		get('log').textContent = get('sidebar').textContent = '';
		get('log').append(arrow);
		get('room').focus();
	}
	socket.on('joinroom', (room, admin, unavailable) => {
		if(document.body.classList.contains('joined')) {
			leave();
		}
		if(unavailable) {
			addsysmsg(room+' is unavailable');
			return;
		}
		socket.on('hideroom', () => get(room).textContent = '('+room+')');
		socket.on('showroom', () => get(room).textContent = room);
		let iframe;
		get('room').placeholder = '';
		if(!get(room)) {
			addroom(room);
		}
		get(room).classList.add('disabled');
		document.title = 'ankabuta'+room;
		history.replaceState(null, '', document.location.pathname+room);
		document.body.classList.add('joined');
		get('msgbox').readOnly = get('say').disabled = false;
		get('log').onscroll = get('codebox').onmousemove = onresize = () => {
			get('arrow').classList[get('log').scrollTop + get('log').clientHeight > get('arrow').previousSibling.offsetTop? 'add': 'remove']('hidden');
		}
		get('arrow').onclick = () => {
			get('arrow').previousSibling.scrollIntoView();
			get('msgbox').focus();
		}
		get('leave').onclick = () => socket.emit('leave');
		const loop = text => {
			const match = text.match(/(^.*?)\[(#(?=[a-f0-9]{3})|°(?=[0-9]{3})|[!*_/-])((?:.*?\[\2.*?\2\])*?.*?)\2\](.*)/si);
			if(!match) return text;
			const frag = document.createDocumentFragment();
			const span = document.createElement('span');
			let color;
			if(match[2] == '#' || match[2] == '°') {
				color = match[3].slice(0, 3);
				match[3] = match[3].slice(3);
			}
			if(match[2] == '!') {
				span.className = 'rainbow';
			} else {
				span.style = { '#':'color:#'+color, '°':'color:hsl('+color+', 100%, 50%)', '*':'font-weight:bold', '_':'text-decoration:underline', '/':'font-style:italic', '-':'text-decoration:line-through' }[match[2]];
			}
			span.append(loop(match[3]));
			frag.append(loop(match[1]), span, loop(match[4]));
			return frag;
		}
		const addmsg = msg => {
			const div = document.createElement('div');
			if(!msg || typeof msg != 'string') return;
			div.append(loop(msg));
			get('arrow').before(div);
			if(get('arrow').classList.contains('hidden')) {
				div.scrollIntoView();
			}
			if(document.visibilityState == 'visible') return;
			msgcount++;
			if(interval) return;
			document.title = '('+msgcount+') ankabuta'+room;
			let i = 0;
			interval = setInterval(() => {
				let title = [...('ankabuta'+room)];
				title[i] = title[i].toUpperCase();
				do {
					i = (i + 1) % title.length;
				} while(title[i] == title[i].toUpperCase());
				document.title = '('+msgcount+') '+title.join('');
			}, 400);
		}
		const stopanimation = () => {
			if(document.visibilityState == 'hidden' || !interval) return;
			interval = clearInterval(interval);
			document.title = 'ankabuta'+room;
			msgcount = 0;
		}
		document.addEventListener('visibilitychange', stopanimation);
		get('msgform').onsubmit = e => {
			e.preventDefault();
			const msg = get('msgbox').value;
			if(!msg) return;
			if(msghistory.at(-1) != msg) {
				msghistory.push(msg);
				msgindex++;
			}
			const arr = msg.split(' ');
			const cmd = arr.shift();
			if(msg[0] == '/') addsysmsg(msg);
			get('msgbox').value = lastmsg = '';
			if(/^\/(join|j)$/.test(cmd)) {
				socket.emit('join', arr.join(' '));
			} else if(/^\/(leave|l)$/.test(cmd)) {
				socket.emit('leave');
			} else if(/^\/(clear|c)$/.test(cmd)) {
				const arrow = get('arrow');
				get('log').textContent = '';
				get('log').append(arrow);
			} else if(iframe) {
				if(/^\/(kick|k)$/.test(cmd)) {
					socket.emit('kick', arr[0], arr[1]);
				} else {
					iframe.contentWindow.hear?.(msg, myname);
				}
			} else {
				socket.emit('say', msg);
			}
		}
		get('msgbox').oninput = () => {
			lastmsg = get('msgbox').value;
			if(msgindex < msghistory.length) {
				msghistory.length = ++msgindex;
			}
		}
		get('msgbox').onkeydown = e => {
			if(e.ctrlKey && e.key == 'ArrowUp') {
				e.preventDefault();
				msgindex = Math.max(msgindex-1, 0);
				get('msgbox').value = msghistory[msgindex] ?? '';
			} else if(e.ctrlKey && e.key == 'ArrowDown') {
				e.preventDefault();
				msgindex = Math.min(msgindex+1, msghistory.length);
				get('msgbox').value = msghistory[msgindex] ?? lastmsg;
			} else if(!e.shiftKey && e.key == 'Enter') {
				e.preventDefault();
				get('say').click();
			}
		}
		addsysmsg('You have joined '+room);
		socket.once('leaveroom', msg => {
			if(interval) {
				interval = clearInterval(interval);
				msgcount = 0;
			}
			document.removeEventListener('visibilitychange', stopanimation);
			get('msgbox').readOnly = get('say').disabled = true;
			get(room)?.classList.remove('disabled');
			for(const event of ['showroom', 'hideroom', 'hear']) {
				socket.off(event);
			}
			if(admin) {
				socket.off('join');
				socket.off('leave');
				iframe.remove();
				iframe = null;
			} else {
				socket.off('change');
			}
			if(msg) {
				document.title = document.title.replace(/^ankabuta#?(.*)$/, 'ankabuta☠️$1');
				addsysmsg(msg);
				get('leave').onclick = () => leave();
			} else {
				document.title = 'ankabuta';
				leave();
			}
		});
		const change = (add, arr) => {
			if(!arr) {
				if(!add) {
					get('sidebar').textContent = '';
				}
				return;
			}
			for(let text of arr) {
				let id;
				if(typeof text != 'string') {
					id = '';
					text = JSON.stringify(text);
				} else {
					id = text.replace(/\s.*/, '');
					text = text.replace(/.*?\s/, '');
				}
				let divid = 'div'+(['youtube', 'dailymotion', 'vimeo'].includes(id)? 'video': id);
				if(!add) {
					get(divid)?.remove();
					continue;
				}
				const div = get(divid) || document.createElement('div');
				const match = {
					'youtube':text.match(/(?<=^|\.be\/|\/v\/|\?v=|\/embed\/)[0-9a-z_-]{11}/i),
					'dailymotion':text.match(/(?<=\/video\/)[0-9a-z_-]+/i),
					'vimeo':text.match(/\d+/),
//					'niconico':text.match(/(?<=\/watch\/)[0-9a-z_-]+/i)
				}[id];
				if(divid == 'divvideo' && match) {
					const video = get('video') || document.createElement('iframe');
					const a = document.createElement('a');
					a.textContent = a.href = {
						'youtube':'https://youtu.be/'+match[0],
						'dailymotion':'https://www.dailymotion.com/video/'+match[0],
						'vimeo':'https://vimeo.com/'+match[0],
//						'niconico':'https://www.nicovideo.jp/watch/'+match[0]
					}[id];
					const embedurl = {
						'youtube':'https://www.youtube-nocookie.com/embed/'+match[0],
						'dailymotion':'https://www.dailymotion.com/embed/video/'+match[0],
						'vimeo':'https://player.vimeo.com/video/'+match[0],
//						'niconico':'https://embed.nicovideo.jp/watch/'+match[0]+'?autoplay=0'
					}[id];
					a.onclick = e => {
						e.preventDefault();
						video.src = embedurl;
						document.querySelector('#divvideo > a.disabled')?.classList.remove('disabled');
						a.classList.add('disabled');
					}
					if(!video.parentNode) {
						video.id = 'video';
						video.allowFullscreen = true;
						div.append(video);
						video.src = embedurl;
						a.classList.add('disabled');
					}
					div.append(a);
					a.scrollIntoView();
					fetch('https://noembed.com/embed?url='+a.href).
						then(x => x.json()).then(x => a.textContent = a.title = x.title);
				} else {
					div.textContent = '';
					div.append(loop(text));
				}
				if(!div.parentNode) {
					div.id = divid;
					get('sidebar')[divid == 'divvideo'? 'prepend': 'append'](div);
				}
			}
		}
		if(!admin) {
			get('msgbox').focus();
			socket.on('change', change);
			socket.on('hear', addmsg);
			return;
		}
		get('codebox').focus();
		get('codebox').value =
			`const users = persistent.users;
			const getName = name => users[name].emoji + '[*[#' + users[name].color + name + '#]*]';
			sendAll(false);
			for(const name in users) {
				join(name);
			}
			function join(name) {
				const emojis = [...'🐱🐀🐄🐆🐇🐉🐊🐍🐎🐏🐐🐑🐒🐕🐖🐘🐙🐞🐡🐢🐧🐨🐩🐫🐬🐮🐼🐿🕊🦃🦄🦆🦇🦈🦉🦊🦋🦍🦎🦏🦒🦓🦔🦕🦖🦘🦚🦛🦜🦝🦡🦢🦣🦤🦥🦦🦧🦨🦩🦫🦬🦭🫏'];
				const num = [...name.replace(/\\d+/, '')].reduce((acc, curr) => acc + curr.charCodeAt(), 0);
				users[name] = { emoji:emojis[num % emojis.length], color:['f00', 'cc0', '0f0', '0cc', '03f'][num % 5] };
				sendOnly(true, Object.keys(users).concat(name+' '+name+' 🡄 You'), name, name);
				sendOnly('Welcome, '+getName(name)+'!', name, getName(name)+' has joined');
			}
			function leave(msg, name) {
				sendAll(getName(name)+' '+msg);
				sendAll(false, name);
			}
			function hear(msg, name) {
				const arr = msg.split(' ');
				const cmd = arr.shift();
				if(cmd == '/pm') {
					sendOnly(getName(name)+' (private): '+arr.slice(1).join(' '), arr[0]);
				} else if(cmd == '/me') {
					sendAll('[/* '+getName(name)+' '+arr.join(' ')+'/]');
				} else {
					sendAll(getName(name)+': '+msg);
				}
			}`.replace(/^\t\t\t/gm, '');
		const codehistory = [];
		let codeindex = 0;
		let runningcode;
		let lastcode;
		document.body.classList.add('admin');
		persistent = { users:{ [myname]:{} } };
		get('codebox').oninput = () => {
			if(codeindex < codehistory.length) {
				codehistory.length = ++codeindex;
			}
			lastcode = get('codebox').value;
			get('codebox').classList[get('codebox').value == runningcode? 'remove': 'add']('changed');
		}
		get('codebox').onkeydown = e => {
			if(e.ctrlKey && e.key == 'ArrowUp') {
				codeindex = Math.max(codeindex-1, 0);
				if(get('codebox').value == codehistory[codeindex]) {
					codeindex = Math.max(codeindex-1, 0);
				}
				get('codebox').value = codehistory[codeindex];
			} else if(e.ctrlKey && e.key == 'ArrowDown') {
				codeindex = Math.min(codeindex+1, codehistory.length);
				if(get('codebox').value == codehistory[codeindex]) {
					codeindex = Math.min(codeindex+1, codehistory.length);
				}
				get('codebox').value = codehistory[codeindex] ?? lastcode;
			} else if(e.key == 'Tab') {
				const start = get('codebox').selectionStart;
				const end = get('codebox').selectionEnd;
				const text = get('codebox').value;
				const arr = [text.slice(0, start), text.slice(start, end), text.slice(end)];
				let num = 0;
				if(e.shiftKey) {
					arr[0] = arr[0].replace(/(^|\n)\t(?!.*\n)/, '$1');
					arr[1] = arr[1].replace(/\n\t/g, '\n');
				} else {
					if(arr[1].includes('\n')) {
						arr[0] = arr[0].replace(/(^|\n)(?!.*\n)/, '$1\t');
						arr[1] = arr[1].replace(/\n/g, '\n\t');
					} else {
						arr[1] = '\t';
						num = 1;
					}
				}
				get('codebox').value = arr.join('');
				get('codebox').selectionStart = arr[0].length + num;
				get('codebox').selectionEnd = arr[0].length + arr[1].length;
				lastcode = get('codebox').value;
			} else return;
			e.preventDefault();
			get('codebox').classList[get('codebox').value == runningcode? 'remove': 'add']('changed');
		}
		iframe = document.createElement('iframe');
		iframe.id = 'iframe';
		get('run').onclick = e => {
			e.preventDefault();
			get('codebox').classList.remove('changed');
			runningcode = get('codebox').value;
			if(!iframe.src || codehistory.at(-1) != runningcode) {
				codehistory.push(runningcode);
				codeindex++;
			}
			if(iframe.src) {
				localStorage.setItem('code', runningcode);
			}
			iframe.src = 'about:blank';
			document.body.append(iframe);
			iframe.contentWindow.persistent = persistent;
			iframe.contentWindow.kick = name => socket.emit('kick', name);
			iframe.contentWindow.print = addmsg;
			const convert = x => !x || Array.isArray(x)? x: [x];
			iframe.contentWindow.sendOnly = (...arr) => {
				if(arr[0] === 1) {
					arr[0] = true;
				} else if(arr[0] === 0) {
					arr[0] = false;
				}
				if(typeof arr[0] == 'boolean') {
					let [add, msgs1, names, msgs2] = arr;
					msgs1 = convert(msgs1);
					names = convert(names);
					msgs2 = convert(msgs2);
					if(names?.includes(myname)) {
						change(add, msgs1);
					} else if(msgs2) {
						change(add, msgs2);
					}
					socket.emit('sendOnly', add, msgs1, names, msgs2);
				} else {
					let [msg1, names, msg2] = arr;
					if(!msg1 || !names) return;
					names = convert(names);
					if(names?.includes(myname)) {
						addmsg(msg1);
					} else if(msg2) {
						addmsg(msg2);
					}
					socket.emit('sendOnly', msg1, names, msg2);
				}
			}
			iframe.contentWindow.sendAll = (...arr) => {
				if(arr[0] === 1) {
					arr[0] = true;
				} else if(arr[0] === 0) {
					arr[0] = false;
				}
				if(typeof arr[0] == 'boolean') {
					let [add, msgs1, names, msgs2] = arr;
					msgs1 = convert(msgs1);
					names = convert(names);
					msgs2 = convert(msgs2);
					if(!names || !names.includes(myname)) {
						change(add, msgs1);
					} else if(msgs2) {
						change(add, msgs2);
					}
					socket.emit('sendAll', add, msgs1, names, msgs2);
				} else {
					let [msg1, names, msg2] = arr;
					if(!msg1) return;
					names = convert(names);
					if(!names || !names.includes(myname)) {
						addmsg(msg1);
					} else if(msg2) {
						addmsg(msg2);
					}
					socket.emit('sendAll', msg1, names, msg2);
				}
			}
			for(const event of ['join', 'leave', 'hear']) {
				iframe.contentWindow[event] = (...arr) => console.log({ 'join':arr[0]+' has joined', 'leave':arr[0]+' has left', 'hear':arr[1]+': '+arr[0] }[event]);
				socket.off(event);
			}
			socket.on('join', (name, hash) => {
				persistent.users[name] = {};
				iframe.contentWindow.join?.(name, hash);
			});
			socket.on('leave', (msg, name, hash) => {
				iframe.contentWindow.leave?.(msg, name, hash);
				delete persistent.users[name];
			});
			socket.on('hear', (msg, name, hash) => iframe.contentWindow.hear?.(msg, name, hash));
			iframe.contentWindow.eval(runningcode);
			onerror = (event, source, row, col) => {
				addsysmsg(event);
				const arr = runningcode.split('\n');
				let index = 0;
				for(let i = 0; i < row - 1; i++) {
					index += arr[i].length + 1; // +1 for the linebreak
				}
				get('codebox').selectionStart = get('codebox').selectionEnd = index + col - 1;
				get('codebox').focus();
			}
		}
		get('run').click();
		const pastcode = localStorage.getItem('code');
		if(pastcode) {
			lastcode = get('codebox').value = pastcode;
			codehistory.push(pastcode);
			codeindex++;
		}
	});
	socket.on('log', (...arr) => console.log(...arr));
});
</script>
</body>
</html>