<!doctype html>
<html>
<head>
<title>ankabuta</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* { font-size:11pt; font-family:sans-serif; margin:0; box-sizing:border-box; tab-size:4; }
textarea:focus, input:focus { outline:1px solid #000; outline-offset:-2px; }
textarea:disabled, input:disabled { border-color:#555; background:#ccc; }
textarea, input { border:1px solid #000; border-radius:3px; }
input { width:80px; }

#wrapper { padding:1px; position:fixed; width:100%; height:calc(100% - 50px); display:flex; }
#wrapper > * { overflow:auto; padding:5px; margin:1px 1px 0 1px; }
#codebox { font:9pt monospace; width:300px; white-space:pre; resize:horizontal; }
#log { flex-grow:1; white-space:pre-wrap; }
.sysmsg { font:bold 10pt monospace; }
#rooms { width:100px; }
#rooms > a { font-weight:bold; color:#09f; text-decoration:none; display:block; }
#rooms > a:hover { color:#f55; }

#form { padding:1px; bottom:0; position:fixed; width:100%; height:50px; display:flex; }
#form * { margin:0 1px 1px 1px; }
#msgbox { flex-grow:1; resize:none; padding:5px; }
#toggle, #run, #codebox, iframe { display:none; }
</style>
</head>
<body>
<div id="wrapper">
<textarea id="codebox" spellcheck="false">function join(name) {
	sendExcept(name+' has joined', name);
	send('Welcome, '+name+'!', name);
}
function leave(name) {
	sendAll(name+' has left');
}
function hear(msg, name) {
	const arr = msg.split(' ');
	const cmd = arr.shift();
	if(cmd == '/pm') {
		send(name+' (private): '+arr.slice(1).join(' '), arr[0]);
	} if(cmd == '/me') {
		sendAll('* '+name+' '+arr.join(' '));
	} else {
		sendAll(name+': '+msg);
	}
}</textarea>
<div id="log" role="log"></div>
<div id="rooms"></div>
</div>
<form id="form">
<input type="button" id="toggle" value="Hide">
<input type="button" id="run" value="Run">
<textarea id="msgbox" disabled></textarea>
<input type="submit" id="say" value="Say" disabled>
</form>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
socket.once('start', (name, rooms) => {
	const get = id => document.getElementById(id);
	const addroom = room => {
		const a = document.createElement('a');
		a.textContent = a.id = a.href = room;
		get('rooms').append(a);
	}
	for(const room of rooms) {
		addroom(room);
	}
	const addmsg = (msg, sys) => {
		const arr = msg.split(/(\*\*|\/\/|--|__)(.+?)\1/);
		const div = document.createElement('div');
		if(sys) {
			div.className = 'sysmsg';
			div.textContent = msg;
		} else {
			for(let i = 0; i < arr.length; i += 3) {
				div.append(arr[i]);
				const span = document.createElement('span');
				span.style = { '**':'font-weight:bold', '//':'font-style:italic', '--':'text-decoration:line-through', '__':'text-decoration:underline' }[arr[i+1]];
				span.textContent = arr[i+2];
				div.append(span);
			}
		}
		get('log').appendChild(div);
		div.scrollIntoView();
	}
	let iframe;
	get('form').onsubmit = e => {
		e.preventDefault();
		const msg = get('msgbox').value;
		if(!msg) return;
		const arr = msg.split(' ');
		const cmd = arr.shift();
		if(msg[0] == '/') addmsg(msg, true);
		if(/^\/(join|j)$/.test(cmd)) {
			socket.emit('join', arr.join(' '));
		} else if(/^\/(leave|l)$/.test(cmd)) {
			socket.emit('leave');
		} else if(iframe) {
			if(/^\/(kick|k)$/.test(cmd)) {
				socket.emit('kick', arr.join(' '));
			} else {
				iframe.contentWindow.hear?.(msg, name);
			}
		} else {
			socket.emit('say', msg);
		}
		get('msgbox').value = '';
	}
	get('msgbox').onkeydown = e => {
		if(!e.shiftKey && e.key == 'Enter') {
			e.preventDefault();
			get('say').click();
		}
	}
	get('codebox').oninput = () => get('run').disabled = false;
	get('codebox').onkeydown = e => {
		if(e.ctrlKey && e.key == 's') {
			e.preventDefault();
			get('run').click();
		} else if(e.key == 'Tab') {
			e.preventDefault();
			const start = get('codebox').selectionStart;
			const end = get('codebox').selectionEnd;
			const text = get('codebox').value;
			const arr = [text.slice(0, start), text.slice(start, end), text.slice(end)];
			let num = 0;
			if(e.shiftKey) {
				arr[0] = arr[0].replace(/\n\t(?!.*\n)/, '\n');
				arr[1] = arr[1].replace(/\n\t/g, '\n');
			} else {
				if(arr[1].includes('\n')) {
					arr[0] = arr[0].replace(/\n(?!.*\n)/, '\n\t');
					arr[1] = arr[1].replace(/\n/g, '\n\t');
				} else {
					arr[1] = '\t';
					num = 1;
				}
			}
			get('codebox').value = arr.join('');
			get('codebox').selectionStart = arr[0].length + num;
			get('codebox').selectionEnd = arr[0].length + arr[1].length;
		}
	}
	socket.on('addroom', addroom);
	socket.on('joinroom', (room, admin) => {
		console.log('hi'); //
		history.replaceState(null, '', document.location.pathname+room);
		document.title = 'ankabuta'+room;
		get('msgbox').disabled = get('say').disabled = false;
		get('msgbox').focus();
		addmsg('You have joined '+room, true);
		if(!admin) {
			socket.on('hear', addmsg);
			return;
		}
		get('codebox').style.display = get('toggle').style.display = get('run').style.display = 'block';
		let bool = false;
		get('toggle').onclick = () => {
			get('codebox').style.display = get('run').style.display = bool? 'block': 'none';
			get('toggle').value = bool? 'Hide': 'Show';
			bool = !bool;
		}
		iframe = document.createElement('iframe');
		get('run').onclick = e => {
			e.preventDefault();
			get('run').disabled = true;
//			iframe.src = 'about:blank';
			document.body.append(iframe);
			iframe.contentWindow.print = msg => addmsg(msg);
			iframe.contentWindow.kick = name2 => socket.emit('kick', name2);
			iframe.contentWindow.send = (msg, name2) => {
				if(name2 == name) {
					addmsg(msg);
				} else {
					socket.emit('send', msg, name2);
				}
			}
			iframe.contentWindow.sendAll = msg => {
				socket.emit('sendAll', msg);
				addmsg(msg);
			}
			iframe.contentWindow.sendExcept = (msg, name2) => {
				if(name2 != name) {
					addmsg(msg);
				}
				socket.emit('sendExcept', msg, name2);
			}
			for(const event of ['join', 'leave', 'hear']) {
//				iframe.contentWindow[event] = (...arr) => console.log({ 'join':arr[0]+' has joined', 'leave':arr[0]+' has left', 'hear':arr[1]+': '+arr[0] }[event]);
				iframe.contentWindow[event] = () => {};
				socket.off(event);
				socket.on(event, (...arr) => iframe.contentWindow[event](...arr));
			}
			iframe.contentWindow.eval(get('codebox').value);
		}
		get('run').click();
	});
	socket.on('rmvroom', room => get(room).remove());
	socket.on('leaveroom', (room, msg, admin) => {
		console.log('bye'); //
		history.pushState(null, '', document.location.pathname);
		document.title = 'ankabuta';
		get('msgbox').disabled = get('say').disabled = true;
		addmsg(msg, true);
		if(!admin) {
			socket.off('hear');
			return;
		}
		for(const event of ['join', 'leave', 'hear']) {
			socket.off(event);
		}
		get('toggle').style.display = get('run').style.display = get('codebox').style.display = 'none';
		iframe.remove();
		iframe = null;
	});
	if(location.hash) {
		socket.emit('join', location.hash);		
	}
	onhashchange = () => {
		console.log(location.hash); //
		socket.emit('join', location.hash);
	}
	socket.on('disconnect', () => {
		get('codebox').disabled = get('run').disabled = get('msgbox').disabled = get('say').disabled = true;
		addmsg('Connection failed!', true);
	});
});
</script>
</body>
</html>