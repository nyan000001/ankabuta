<!doctype html>
<html lang="en">
<head>
<title>ankabuta</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
<style>
@font-face { font-family:'Noto Color Emoji'; font-style:normal; font-weight:400; font-display:swap; size-adjust:120%; unicode-range:U+2139-2B04, U+2B96-FE837, U+200D; src:url('NotoColorEmoji.ttf') format('truetype'); }
* { font-size:11pt; font-family:'Noto Color Emoji', sans-serif; margin:0; box-sizing:border-box; tab-size:4; line-height:18px; }
#log input, #sidebar input { user-select:all; }
textarea, input, select, #arrow { border:1px solid #000; border-radius:3px; }
textarea:focus, input:focus, select:focus { outline:1px solid #000; outline-offset:-2px; }
input[type=text]:read-only, textarea:read-only, input:disabled { border-color:#555 !important; background:#ccc; color:#888; outline:none; }
input[type=checkbox] { vertical-align:middle; }
a { font-weight:bold; color:#09f; text-decoration:none; display:block; }
.joined #rooms.hidden, .joined #rooms div, #codebox, #log, #arrow.hidden, #sidebar, #help.hidden, #help .hidden, #msgform > *, #iframe { display:none; }
.joined #log, .joined #sidebar, .joined #leave, .joined #msgbox, .joined #say { display:block; }
.admin #help div.hidden, .admin #codebox, .admin #run { display:block; }
.admin #help span.hidden { display:inline; }
#rooms a.hidden, #rooms a.locked { opacity:.5; }
#rooms a.locked::after { content:'🔒'; }

#rooms { flex-grow:1; flex-shrink:1; }
.joined #rooms { width:100px; flex-grow:0; flex-shrink:0; }
#rooms .sysmsg { text-align:center; }
#roomform { white-space:normal; max-width:100%; width:200px; margin:auto; }
#roomform > label { text-align:left; display:block; font-size:10pt; line-height:14px; }
#roomform > input { margin:1px auto; display:block; }
#roomform > input[type=text] { padding:0 4px; width:100%; margin-bottom:4px; }
#rooms > a { display:inline-block; padding:10px 20px; margin:2px; line-height:12px; }
.joined #rooms > a { display:block; padding:6px; padding-left:6px; text-indent:-6px; }
a:hover, a:focus-visible { color:#f55; outline:none; }
a.disabled, #rooms.disabled > a { color:#000; pointer-events:none; }

#wrapper { display:flex; position:fixed; width:100%; padding:1px 1px 0 1px; height:100%; }
.joined #wrapper { height:calc(100% - 50px); }
#wrapper > * { margin:1px; }
#wrapper > *:not(#log, #help) { padding:5px; }
#wrapper > *:not(#codebox, #help), #help > div > div { white-space:pre-wrap; overflow-wrap:break-word; }
#wrapper > *:not(#codebox) { overflow-y:auto; }
#codebox { width:300px; resize:horizontal; }
#codebox, pre { font-size:10pt; line-height:17px; white-space:pre; }
#codebox, pre, code, #help summary { font-family:'Noto Color Emoji', monospace; }
#codebox.changed { border-color:#f00; outline-color:#f00; }
#codebox, #sidebar, #help { flex-shrink:0; }
#log { flex-grow:1; }
.msg:nth-last-child(2) { margin-bottom:-24px; }

.msg { padding:3px; max-height:50%; overflow:auto; }
.clickable { cursor:pointer; }
.scrollup { background:linear-gradient(rgba(127.5, 127.5, 127.5, .2), transparent) no-repeat top; background-size:100% 20px; }
.scrolldown { background:linear-gradient(transparent, rgba(127.5, 127.5, 127.5, .2)) no-repeat bottom; background-size:100% 20px; }
.scrollup.scrolldown { background:linear-gradient(rgba(127.5, 127.5, 127.5, .2), transparent) no-repeat top, linear-gradient(transparent, rgba(127.5, 127.5, 127.5, .2)) no-repeat bottom; background-size:100% 20px; }
.msg form, #sidebar form { display:inline-block; border:1px solid #aaa; border-radius:4px; padding:1px; max-width:100%; }
.msg input, .msg select, #sidebar input, #sidebar select { margin:1px; }
.rainbow { background:linear-gradient(90deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00) 0 0/100px 100px; -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
del { text-decoration:line-through; opacity:.5; }
.msg .big, .msg .big *, #sidebar .big, #sidebar .big *, #help .big { font-size:17pt; line-height:26px; }
.msg .big input, .msg .big select, #sidebar .big input, #sidebar .big select { line-height:30px; }
.msg .small, .msg .small *, #sidebar .small, #sidebar .small *, #help .small { font-size:8pt; }
.msg .small input, .msg .small select, #sidebar .small input, #sidebar .small select  { line-height:10px; }
.sysmsg { font-weight:bold; }
#arrow { width:100%; bottom:0; position:sticky; height:24px; background:ButtonFace; text-align:center; line-height:22px; text-overflow:ellipsis; overflow:hidden; white-space:nowrap; cursor:default; user-select:none; }
#arrow * { pointer-events:none; }
#msg big * { padding:0; }
pre { display:inline; }
details { display:inline-block; vertical-align:top; margin-left:1em; }
summary { cursor:default; margin-left:-1em; }
i * { font-style:italic; }
b * { font-weight:bold; }

#sidebar { max-width:min(35vw, 250px); }
#sidebar:empty { display:none; }
#divvideo { max-height:min(35vw, 250px); overflow-y:auto; }
#video { position:sticky; top:0; width:100%; aspect-ratio:16 / 9; }
#divvideo > a { line-height:15px; padding:2px; }
#sidebar a.disabled { pointer-events:none; cursor:auto; }

#help { padding:0 5px; line-height:13pt; }
#help > div { padding:1px 0; }
#help > div > div { margin:5px 0; white-space:pre; }
kbd { border-radius:4px; padding:2px; border:1px solid #888; display:inline-block; min-width:20px; text-align:center; }
var { opacity:.5; font-style:inherit; font-family:inherit; }

#msgform { bottom:0; position:fixed; width:100%; height:50px; display:flex; padding:0 1px 1px 1px; }
#msgform > * { margin:1px; }
#msgform > input { width:80px; }
#msgbox { flex-grow:1; resize:none; padding:5px; }

.shortcut { position:fixed; line-height:20px; width:20px; text-align:center; pointer-events:none; background:#000; color:#fff; font-weight:bold; }

@media (max-width:900px) {
	.admin:has(#help:not(.hidden)) #wrapper > * { height:calc(50% - 30px); }
	.admin:has(#help:not(.hidden)) #codebox { position:fixed; bottom:50px; height:50%; width:calc(100% - 4px) !important; resize:none; }
}

@media (max-width:600px) {
	.admin #wrapper > * { height:calc(50% - 30px); }
	.admin #codebox { position:fixed; bottom:50px; height:50%; width:calc(100% - 4px) !important; resize:none; }
	.joined:has(#help:not(.hidden)) #sidebar { display:none; }
}

@media (prefers-color-scheme:dark) {
	body { background:#000; color:#fff; }
	textarea, input, select, #arrow { background:#000; color:#fff; border-color:#ccc; }
	textarea:focus, input:focus, select:focus { outline-color:#ccc; background:#111; }
	input[type=button], input[type=submit], #arrow { background:#222; }
	input[type=button]:focus, input[type=submit]:focus { background:#333; }
	input[type=text]:read-only, textarea:read-only, input:disabled { background:#000; color:#444; }
	input[type=checkbox] { filter:invert(100%); }
	.msg form, #sidebar form  { border-color:#555; }
	::-webkit-scrollbar { width:15px; height:15px; }
	::-webkit-scrollbar-track { background:#222; }
	::-webkit-scrollbar-thumb { background-color:#333; border:1px solid #555; }
	::-webkit-scrollbar-corner { background:#333; }
	::-webkit-resizer { border-width:8px; border-style:solid; border-color:transparent #999 #999 transparent; }
	textarea { cursor:auto; }
	a.disabled, #rooms.disabled > a { color:#fff; }
	.shortcut { background:#ccc; color:#000; box-shadow:0 0 5px #000; }
}

@media (prefers-color-scheme:light) {
	.color { text-shadow:-1px -1px 1px #000, -1px 0 1px #000, -1px 1px 1px #000, 0 -1px 1px #000, 0 1px 1px #000, 1px -1px 1px #000, 1px 0 1px #000, 1px 1px 1px #000; }
}

@media (prefers-reduced-motion:no-preference) {
	@keyframes move { to { background-position:500px 0; } }
	.rainbow { animation:move 15s ease-out 1; }
}
</style>
<meta name="description" content="Create a chatroom with your own code or join other people's rooms">
</head>
<body>
<div id="wrapper">
<div id="rooms" class="hidden"><form id="roomform">
<label for="room">Room name</label>
<input type="text" id="room" maxlength="30" autofocus>
<label for="name">Username (optional)</label>
<input type="text" id="name" maxlength="30">
<input type="submit" id="go" value="Go"></form></div>
<textarea id="codebox" spellcheck="false"></textarea>
<div id="log" role="log"><div id="arrow" class="hidden">⬇</div></div>
<div id="sidebar" role="log"></div>
<div id="help" class="hidden">
<div>
<div><kbd>ctrl</kbd> + <kbd id="togglehelp">h</kbd>
	<i>Toggle the help menu</i></div>
<div><kbd>ctrl</kbd> + <kbd id="togglerooms">o</kbd>
	<i>Show or hide the rooms</i></div>
<div><kbd>ctrl</kbd> + <kbd>⬆</kbd>
	<i>Previous message<span class="hidden"> or code</span></i></div>
<div><kbd>ctrl</kbd> + <kbd>⬇</kbd>
	<i>Next message<span class="hidden"> or code</span></i></div>
<div class="hidden"><kbd>ctrl</kbd> + <kbd id="runcode">s</kbd>
	<i>Save and run the code</i></div>
<div class="hidden"><kbd>ctrl</kbd> + <kbd id="clickerror">e</kbd>
	<i>Click the first error message</i></div>
<div><kbd>alt</kbd> + <kbd id="focuscodebox">c</kbd> / <kbd id="focusleave">l</kbd> / <kbd id="focusrun">r</kbd> / <kbd id="focusmsgbox">m</kbd> / <kbd id="focussay">s</kbd>
	<i>Set focus to specific elements
	(Hold down <kbd>alt</kbd> to see the labels)</i></div>
</div><div>
<div><code>[&lt;sample text&gt;]</code> <span class="big">sample text</span></div>
<div><code>[&gt;sample text&lt;]</code> <span class="small">sample text</span></div>
<div><code>[{sample text}]</code> <pre>sample text</pre></div>
<div><code>[!sample text!]</code> <span class="rainbow">sample text</span></div>
<div><code>[*sample text*]</code> <b>sample text</b></div>
<div><code>[/sample text/]</code> <i>sample text</i></div>
<div><code>[_sample text_]</code> <span style="text-decoration:underline">sample text</span></div>
<div><code>[-sample text-]</code> <del>sample text</del></div>
<div><code>[#f00sample text#]</code> <span style="color:#f00">sample text</span></div>
<div><code>[°360sample text°]</code> <span style="color:hsl(360, 100%, 50%)">sample text</span></div>
<div><details><summary>[(sample text)]</summary>sample text</details></div>
</div><div class="hidden">
<div><code>sendOnly(<var>message1, users, message2</var>)</code>
	<i>Sends <var>message1</var> to <var>users</var>
	and sends <var>message2</var> to everyone else</i></div>
<div><code>sendAll(<var>message1, users, message2</var>)</code>
	<i>Sends <var>message1</var> to everyone but <var>users</var>
	and sends <var>message2</var> to <var>users</var></i></div>
<div><code>sendAll(true, <var>word</var>)</code>
	<i>Adds <var>word</var> to everyone's sidebar</i></div>
<div><code>sendAll(false, <var>word</var>)</code>
	<i>Removes <var>word</var> from everyone's sidebar</i></div>
<div><code>kick(<var>name</var>, <var>msg</var>)</code>
	<i>Kicks <var>name</var></i></div>
<div><code>ban(<var>hash</var>, <var>minutes</var>, <var>msg</var>)</code>
	<i>Bans <var>hash</var> for <var>minutes</var></i></div>
<div><code>lock(<var>minutes</var>)</code>
	<i>Locks the room for <var>minutes</var></i></div>
</div>
</div>
</div>
<form id="msgform">
<input type="button" id="leave" value="Leave">
<input type="button" id="run" value="Run">
<textarea id="msgbox" aria-label="Message" maxlength="5000"></textarea>
<input type="submit" id="say" value="Say">
</form>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
if(!Array.prototype.at) {
	Array.prototype.at = function(num) {
		return num < 0? this[this.length+num]: this[num];
	}
}
const get = id => document.getElementById(id);
const kbds = document.getElementsByTagName('kbd');
for(let i = 0; i < kbds.length; i++) {
	if(kbds[i].id) kbds[i].textContent = localStorage.getItem(kbds[i].id) || kbds[i].textContent;
}
if(localStorage.getItem('showrooms')) get('rooms').classList.remove('hidden');
if(localStorage.getItem('showhelp')) get('help').classList.remove('hidden');
const style = localStorage.getItem('style');
if(style) document.getElementsByTagName('style')[0].append(style);
const script = localStorage.getItem('script');
if(script) eval(script);
socket.once('start', rooms => {
	let animation;
	let msgcount = 0;
	const msghistory = [];
	let msgindex = 0;
	let lastmsg = '';
	let myroom = '';
	if(location.hash) {
		socket.emit('join', decodeURI(location.hash));
	}
	onhashchange = () => {
		socket.emit('join', decodeURI(location.hash));
	}
	const scrollmsg = onscroll = msg => {
		msg.classList.remove('scrollup', 'scrolldown');
		if(msg.scrollHeight > msg.clientHeight) {
			if(msg.scrollTop > 3) {
				msg.classList.add('scrollup');
			}
			if(Math.abs(msg.scrollHeight - msg.clientHeight - msg.scrollTop) > 3) {
				msg.classList.add('scrolldown');
			}
		}
	}
	get('codebox').onmousemove = onresize = () => {
		if(get('arrow').classList.contains('hidden')) {
			get('log').scrollTop = get('log').scrollHeight;
		}
		const msgs = get('log').getElementsByClassName('msg');
		for(let i = 0; i < msgs.length; i++) {
			scrollmsg(msgs[i]);
		}
	}
	let ignorescroll;
	get('log').onscroll = () => {
		if(ignorescroll) {
			ignorescroll = false;
			return;
		}
		get('arrow').classList[get('log').scrollHeight - get('log').scrollTop - get('log').clientHeight > 3? 'remove': 'add']('hidden');
	}
	const scrolldown = () => {
		if(!get('arrow').classList.contains('hidden')) return;
		ignorescroll = true;
		get('log').scrollTop = get('log').scrollHeight;
	}
	const addsysmsg = msg => {
		const div = document.createElement('div');
		div.classList.add('sysmsg');
		div.textContent = msg;
		if(document.body.classList.contains('joined')) {
			div.classList.add('msg');
			get('arrow').before(div);
			scrolldown();
		} else {
			document.querySelector('#rooms > .sysmsg')?.remove();
			get('roomform').after(div);
		}
		return div;
	}
	const stopanimation = () => {
		animation = clearInterval(animation);
		msgcount = 0;
		document.removeEventListener('visibilitychange', visibilitychange);
	}
	const visibilitychange = () => {
		if(document.visibilityState == 'hidden') return;
		stopanimation();
		document.title = 'ankabuta#'+myroom;
	}
	socket.once('disconnect', () => {
		onbeforeunload = null;
		stopanimation();
		document.title = 'ankabuta☠️'+myroom;
		get('room').readOnly = get('name').readOnly = get('go').disabled = get('codebox').readOnly = get('run').disabled = get('msgbox').readOnly = get('say').disabled = true;
		get('leave').onclick = () => location.href = '/';
		addsysmsg('Connection failed!');
		get('rooms').classList.add('disabled');
		socket.disconnect();
	});
	const updateroom = (room, num) => {
		if(num == 0) {
			get(room).remove();
		} else {
			let a = get(room);
			if(!a) {
				a = document.createElement('a');
				a.id = a.href = room;
				get('rooms').append(a);
			}
			if(room.includes('hidden')) {
				a.classList.add('hidden');
			}
			a.textContent = room+' ('+num+')';
		}
	}
	for(const arr of rooms) {
		updateroom(arr[0], arr[1]);
	}
	onkeydown = e => {
		if(!document.body.classList.contains('joined')) return;
		if(e.altKey) {
			const key = e.key.toLowerCase();
			if(key == (localStorage.getItem('focuscodebox') || 'c') && document.body.classList.contains('admin')) {
				get('codebox').focus();
			} else if(key == (localStorage.getItem('focusleave') || 'l')) {
				get('leave').focus();
			} else if(key == (localStorage.getItem('focusrun') || 'r') && document.body.classList.contains('admin')) {
				get('run').focus();
			} else if(key == (localStorage.getItem('focusmsgbox') || 'm')) {
				get('msgbox').focus();
			} else if(key == (localStorage.getItem('focussay') || 's')) {
				get('say').focus();
			} else {
				if(document.getElementsByClassName('shortcut').length) return;
				const arr = ['leave', 'msgbox', 'say'];
				if(document.body.classList.contains('admin')) {
					arr.push('codebox', 'run');
				}
				for(const el of arr) {
					const rect = get(el).getBoundingClientRect();
					const div = document.createElement('div');
					div.className = 'shortcut';
					div.style.left = rect.left+'px';
					div.style.top = rect.top+'px';
					div.textContent = localStorage.getItem('focus'+el) || el[0];
					document.body.append(div);
				}
			}
		} else if(e.ctrlKey) {
			let flag;
			const scroll = get('arrow').classList.contains('hidden');
			if(e.key == (localStorage.getItem('togglerooms') || 'o')) {
				get('rooms').classList.toggle('hidden');
				flag = true;
			}
			if(e.key == (localStorage.getItem('togglehelp') || 'h')) {
				get('help').classList.toggle('hidden');
				flag = true;
			}
			if(e.key == (localStorage.getItem('runcode') || 's') && document.body.classList.contains('admin')) {
				get('run').click();
				flag = true;
			}
			if(e.key == (localStorage.getItem('clickerror') || 'e')) {
				document.getElementsByClassName('clickable')[0]?.click();
				flag = true;
			}
			if(flag) {
				e.preventDefault();
				if(scroll) {
					ignorescroll = true;
					get('log').scrollTop = get('log').scrollHeight;
				}
			}
		}
	}
	onkeyup = onblur = e => {
		if(e.key && e.key != 'Alt' && e.key != 'Meta') return;
		const shortcuts = document.getElementsByClassName('shortcut');
		while(shortcuts[0]) {
			shortcuts[0].remove();
		}
	}
	ontouchstart = e => {
		if(e.target == get('codebox')) return;
		get('help').firstElementChild.innerHTML = '<div>Tap to close this menu</div>';
		let dist = innerWidth - e.changedTouches[0].clientX;
		if(get('help').classList.contains('hidden')) {
			if(dist > 20 && get('help').classList.contains('hidden')) return;
		} else {
			if(Math.abs(dist - get('help').offsetWidth) > 40) return;
		}
		ontouchmove = e => {
			dist = innerWidth - e.changedTouches[0].clientX;
			if(dist < 150) {
				get('help').classList.add('hidden');
				get('help').style.opacity = .5;
			} else {
				get('help').classList.remove('hidden');
				get('help').style.opacity = 1;
			}
			get('help').style.width = dist + 'px';
			get('help').style.display = 'block';
		}
		ontouchend = e => {
			get('help').removeAttribute('style');
			ontouchmove = ontouchend = null;
		}
	}
	get('help').ontouchstart = e => {
		if(e.target.tagName == 'SUMMARY') return;
		get('help').ontouchmove = () => get('help').ontouchend = null;
		get('help').ontouchend = () => get('help').classList.add('hidden');
	}
	get('roomform').onsubmit = e => {
		e.preventDefault();
		const room = get('room').value.trim();
		if(!room) return;
		get('room').value = '';
		socket.emit('join', room, get('name').value.trim());
	}
	get('room').ondrop = e => {
		e.preventDefault();
		get('room').value = e.dataTransfer.getData('text/plain').replace(/.*?#/, '#');
		if(get('name').value) get('go').focus();
		else get('name').focus();
	}
	get('room').onkeydown = get('name').onkeydown = e => {
		if(!e.shiftKey && e.key == 'Enter') {
			e.preventDefault();
			get('go').click();
		}
	}
	get('go').onclick = () => {
		if(!get('room').value.trim()) {
			get('room').focus();
		}
	};
	socket.on('notify', (msg, kick) => {
		addsysmsg(msg);
		if(kick) {
			history.replaceState(null, '', document.location.pathname);
		}
	});
	socket.on('updateroom', updateroom);
	const join = (room, myname, adminhash, customname) => {
		onbeforeunload = () => true;
		document.querySelector('#rooms > div')?.remove();
		myroom = room.slice(1);
		socket.on('lockroom', () => get(room).classList.add('locked'));
		socket.on('unlockroom', () => get(room).classList.remove('locked'));
		let iframe;
		get(room).classList.add('disabled');
		document.title = 'ankabuta'+room;
		get('codebox').readOnly = get('run').disabled = get('msgbox').readOnly = get('say').disabled = false;
		let focus = localStorage.getItem('focus');
		if(['codebox', 'run'].includes(focus) && !adminhash) focus = 'msgbox';
		setTimeout(() => get(focus || 'msgbox')?.focus());
		history.replaceState(null, '', document.location.pathname+room);
		document.body.classList.add('joined');
		get('arrow').onclick = () => {
			get('arrow').classList.add('hidden');
			scrolldown();
			get('msgbox').focus();
		}
		get('leave').onclick = () => {
			if(get('leave').value.endsWith('?')) {
				socket.emit('leave');
			} else {
				get('leave').value += '?';
			}
		}
		get('log').onclick = get('sidebar').onclick = e => {
			if(e.target.type == 'button' || e.target.type == 'submit') {
				if(e.target.type == 'submit') {
					const form = e.target.closest('form');
					if(!form) return;
					msg = [e.target.value];
					const inputs = [...form.querySelectorAll('input[type=text], input[type=password], select')];
					for(const input of inputs) {
						msg.push(input.nextSibling?.type == 'checkbox'? 'hash:'+input.value: input.value);
						input.value = '';
					}
					msg = '/'+msg.join(' ');
				} else msg = '/'+e.target.value;
				if(iframe) {
					console.log(myname+': '+msg);
					iframe.contentWindow.hear(msg, myname, adminhash);
				} else {
					socket.emit('say', msg);
				}
				get('msgbox').focus();
			} else if(e.target.type == 'checkbox') {
				e.target.previousSibling.type = e.target.checked? 'text': 'password';
				e.target.previousSibling.focus();
			} else if(e.target.tagName == 'LABEL') {
				e.target.nextElementSibling?.focus();
			} else if(e.target.closest('DETAILS')) {
				setTimeout(scrolldown);
				get('msgbox').focus();
			} else if(e.detail == 3 && e.target.tagName == 'PRE') {
				const selection = window.getSelection();
				selection.removeAllRanges();
				const range = document.createRange();
				range.selectNodeContents(e.target);
				selection.addRange(range);
			}
		}
		get('log').onkeydown = get('sidebar').onkeydown = e => {
			if(e.key != 'Enter') return;
			e.preventDefault();
			if(e.target.type == 'text' || e.target.type == 'password' || e.target.tagName == 'SELECT') {
				e.target.closest('form')?.querySelector('input[type=submit]')?.click();
			} e.target.click();
		}
		get('log').onsubmit = get('sidebar').onsubmit = e => e.preventDefault();
		const gethtml = text => {
			let html = '';
			const arr = text.split(/\[\{(.*)\}\]/s);
			for(let i = 0; i < arr.length; i++) {
				text = arr[i].replaceAll('<', '&lt;').replaceAll('>', '&gt;');
				if(i % 2) {
					html += '<pre>'+text+'</pre>';
				} else {
					let temp;
					do {
						temp = text;
						text = text.
							replace(/\[\[([^\[]*?)\]\]/gs, (_, tag) => {
								if(tag.startsWith('select|')) return ('<select><option>'+tag.slice(7).replace(/\|/g, '</option><option>')+'</option></select>').replace(/"/g, '&quot;').replace(/>([^<]*?):([^<]*?)</g, ' value="$1">$2<');
								let style = tag.startsWith('long')? 'width:300px;': tag.startsWith('short')? 'width:40px;': 'width:100px;';
								tag = tag.replace(/^(long|short)/, '');
								if(tag == 'text') return '<input type="'+tag+'" style="'+style+' max-width:calc(100% - 2px)">';
								if(tag == 'password') return '<input type="'+tag+'" style="'+style+' max-width:calc(100% - 20px)"><input type="checkbox" title="Show password">';
								if(tag == 'button' || tag == 'submit') return '<input type="'+tag+'" value="send">';
								const match = tag.match(/^(?<tag>\w+):(?<value>.*)/)?.groups;
								if(match) {
									match.value = match.value.replace(/<.*?>/g, '').replaceAll('"', '&quot;');
									if(match.tag == 'text') return '<input type="'+match.tag+'" placeholder="'+match.value+'" style="'+style+' max-width:calc(100% - 2px)">';
									if(match.tag == 'password') return '<input type="'+match.tag+'" placeholder="'+match.value+'" style="'+style+' max-width:calc(100% - 20px)"><input type="checkbox" title="Show password">';
									if(match.tag == 'button' || match.tag == 'submit') return '<input type="'+match.tag+'" value="'+match.value+'">';
									if(match.tag == 'label') return '<label>'+match.value+'</label>';
								}
								return '<form>'+tag+'</form>';
							}).
							replace(/\[\((?:(.*?)\|)?(.*?)\)\]/gs, '<details><summary>$1</summary>$2</details>').
							replace(/\[!(.*?)!\]/gs, '<span class="rainbow">$1</span>').
							replace(/\[#([0-9a-f]{3})(.*?)#\]/gsi, '<span class="color" style="color:#$1">$2</span>').
							replace(/\[°([0-9a-f]{3})(.*?)°\]/gsi, '<span class="color" style="color:hsl($1, 100%, 50%)">$2</span>').
							replace(/\[\*(.*?)\*\]/gs, '<b>$1</b>').
							replace(/\[\/(.*?)\/\]/gs, '<i>$1</i>').
							replace(/\[_(.*?)_\]/gs, '<span style="text-decoration:underline">$1</span>').
							replace(/\[-(.*?)-\]/gs, '<del>$1</del>').
							replace(/\[&lt;(.*?)&gt;\]/gs, '<span class="big">$1</span>').
							replace(/\[&gt;(.*?)&lt;\]/gs, '<span class="small">$1</span>');
					} while(temp != text);
					html += text;
				}
			}
			return html;
		}
		let timeout;
		const addmsg = msg => {
			if(!msg || typeof msg != 'string') return;
			const div = document.createElement('div');
			div.classList.add('msg');
			div.innerHTML = gethtml(msg);
			get('arrow').before(div);
			scrolldown();
			scrollmsg(div);
			div.onscroll = () => scrollmsg(div);
			if(document.visibilityState == 'visible') {
				if(!get('arrow').classList.contains('hidden')) {
					get('arrow').innerHTML = div.innerHTML;
					if(timeout) clearTimeout(timeout);
					timeout = setTimeout(() => {
						timeout = null;
						get('arrow').textContent = '⬇';
					}, 2000);
				}
				return;
			}
			msgcount++;
			if(animation) return;
			document.title = '('+msgcount+') ankabuta'+room;
			let i = 0;
			animation = setInterval(() => {
				let title = [...('ankabuta'+room)];
				title[i] = title[i].toUpperCase();
				do {
					i = (i + 1) % title.length;
				} while(title[i] == title[i].toUpperCase());
				document.title = '('+msgcount+') '+title.join('');
			}, 400);
			document.addEventListener('visibilitychange', visibilitychange);
		}
		get('msgform').onsubmit = e => {
			e.preventDefault();
			get('msgbox').focus();
			const msg = get('msgbox').value;
			if(!msg) return;
			if(msgindex < msghistory.length) {
				msghistory.length = ++msgindex;
			}
			if(msghistory.at(-1) != msg) {
				msghistory.push(msg);
				msgindex++;
			}
			const arr = msg.split(/ +/);
			const cmd = arr.shift();
			//if(msg[0] == '/') addsysmsg(msg);
			get('msgbox').value = lastmsg = '';
			if(iframe) {
				console.log(myname+': '+msg);
				iframe.contentWindow.hear(msg, myname, adminhash);
			} else {
				socket.emit('say', msg);
			}
		}
		get('msgbox').oninput = () => {
			lastmsg = get('msgbox').value;
			if(msgindex < msghistory.length) {
				msghistory.length = ++msgindex;
			}
		}
		get('msgbox').onkeydown = e => {
			if(e.ctrlKey && e.key == 'ArrowUp') {
				e.preventDefault();
				msgindex = Math.max(msgindex-1, 0);
				get('msgbox').value = msghistory[msgindex] ?? '';
			} else if(e.ctrlKey && e.key == 'ArrowDown') {
				e.preventDefault();
				msgindex = Math.min(msgindex+1, msghistory.length);
				get('msgbox').value = msghistory[msgindex] ?? lastmsg;
			} else if(!e.shiftKey && e.key == 'Enter') {
				e.preventDefault();
				get('say').click();
			}
		}
		addsysmsg('You have joined '+room);
		socket.once('leaveroom', msg => {
			onbeforeunload = null;
			get('leave').value = get('leave').value.replace('?', '');
			stopanimation();
			get('codebox').readOnly = get('run').disabled = get('msgbox').readOnly = get('say').disabled = true;
			history.replaceState(null, '', document.location.pathname);
			if(get(room).classList.contains('hidden') || get(room).classList.contains('locked')) {
				updateroom(room, 0);
			} else {
				get(room).classList.remove('disabled');
			}
			for(const event of ['lockroom', 'unlockroom', 'hear']) {
				socket.off(event);
			}
			if(adminhash) {
				socket.off('join');
				socket.off('leave');
				iframe.remove();
				iframe = null;
			} else {
				socket.off('updatesidebar');
			}
			let leave = () => {
				myroom = '';
				document.title = 'ankabuta';
				document.body.classList.remove('joined', 'admin');
				const arrow = get('arrow');
				get('log').textContent = get('sidebar').textContent = '';
				get('log').append(arrow);
				get('room').focus();
				leave = () => {};
			}
			if(msg) {
				document.title = 'ankabuta☠️'+myroom;
				addmsg('[*'+msg+'*]');
				get('leave').onclick = () => leave();
				socket.once('joinroom', (...arr) => {
					leave();
					join(...arr);
				});
			} else {
				leave();
				socket.once('joinroom', join);
			}
		});
		const updatesidebar = (add, arr) => {
			if(add == false && arr == undefined) {
				get('sidebar').textContent = '';
				return;
			}
			if(!Array.isArray(arr) || arr.length == 0) return;
			for(let text of arr) {
				let id;
				if(typeof text != 'string') {
					id = '';
					text = JSON.stringify(text);
				} else {
					id = text.replace(/\s.*/s, '');
					text = text.replace(/.*?\s/s, '');
				}
				let divid = 'div'+(['youtube', 'dailymotion', 'vimeo'].includes(id)? 'video': id);
				if(!add) {
					get(divid)?.remove();
					continue;
				}
				const div = get(divid) || document.createElement('div');
				const match = {
					'youtube':text.match(/(?<=^|\.be\/|\/v\/|\?v=|\/embed\/|\/shorts\/)[0-9A-Za-z_-]{11}/),
					'dailymotion':text.match(/(?<=\/video\/)[0-9A-Za-z_-]+/),
					'vimeo':text.match(/\d+/)
				}[id];
				if(divid == 'divvideo' && match) {
					const video = get('video') || document.createElement('iframe');
					const a = document.createElement('a');
					a.textContent = a.href = {
						'youtube':'https://youtu.be/'+match[0],
						'dailymotion':'https://www.dailymotion.com/video/'+match[0],
						'vimeo':'https://vimeo.com/'+match[0]
					}[id];
					const embedurl = {
						'youtube':'https://www.youtube-nocookie.com/embed/'+match[0],
						'dailymotion':'https://www.dailymotion.com/embed/video/'+match[0],
						'vimeo':'https://player.vimeo.com/video/'+match[0]
					}[id];
					a.onclick = e => {
						e.preventDefault();
						video.src = embedurl;
						document.querySelector('#divvideo > a.disabled')?.classList.remove('disabled');
						a.classList.add('disabled');
					}
					if(!video.parentNode) {
						video.id = 'video';
						video.allowFullscreen = true;
						div.append(video);
						video.src = embedurl;
						a.classList.add('disabled');
					}
					div.append(a);
					a.scrollIntoView();
					fetch('https://noembed.com/embed?url='+a.href).then(x => x.json()).then(x => a.textContent = x.title);
				} else {
					div.textContent = '';
					div.innerHTML = gethtml(text);
				}
				if(!div.parentNode) {
					div.id = divid;
					get('sidebar')[divid == 'divvideo'? 'prepend': 'append'](div);
				}
			}
			scrolldown();
		}
		if(!adminhash) {
			socket.on('updatesidebar', updatesidebar);
			socket.on('hear', addmsg);
			return;
		}
		get('codebox').value =
			`const users = persistent.users;
			persistent.colors = persistent.colors ?? ['f20', 'f70', 'ff0', '0f0', '0ff', '06f', '70f', 'e09'];
			persistent.ids = persistent.ids ?? [0];
			const help = 'Available commands: /help /nick /pm /me /pat /hug /poke /cookie /cupcake /donut';
			function join(name, hash) {
				const user = users[name];
				if(!user.alias) {
					const color = persistent.colors.shift();
					persistent.colors.push(color);
					user.alias = '[*[#'+color+name+'#]*]';
					if(persistent.ids.length == 1) {
						user.id = persistent.ids[0]++;
					} else {
						persistent.ids.sort((a, b) => b - a);
						user.id = persistent.ids.pop();
					}
				}
				sendAll('[*'+user.alias+' has joined*]');
				sendOnly(help, name);
				sendAll(true, name+' '+user.id+' '+user.alias,
					name, Object.keys(users).map(name2 => name2+' '+users[name2].id+' '+users[name2].alias));
			}
			function leave(msg, name, hash) {
				const user = users[name];
				sendAll('[*'+user.alias+' '+msg+'*]');
				sendAll(false, name);
				persistent.ids.push(user.id);
			}
			function hear(msg, name, hash) {
				const user = users[name];
				if(msg[0] == '/') {
					const words = msg.split(' ');
					let cmd = words.shift().slice(1).toLowerCase();
					if(cmd[0] == '!' && user.admin) {
						cmd = cmd.slice(1);
						if(['kick', 'k'].includes(cmd)) {
							kick(words.shift(), words.join(' '));
						} else if(['ban', 'b'].includes(cmd)) {
							ban(words.shift(), words.shift(), words.join(' '));
						} else if(['lock', 'l'].includes(cmd)) {
							lock(words[0]);
						} else {
							sendOnly('Invalid command', name);
						}
					} else if(['help', 'h'].includes(cmd)) {
						sendOnly(help, name);
					} else if(['nick', 'name', 'n'].includes(cmd)) {
						const oldalias = user.alias;
						user.alias = words.join('_');
						sendAll('[*'+oldalias+' is now known as '+user.alias+'*]');
						sendAll(true, name+' '+user.id+' '+user.alias);
					} else if(['pm', 'whisper', 'dm'].includes(cmd)) {
						const id = parseInt(words.shift());
						const name2 = Object.entries(users).find(user2 => user2[1].id == id)?.[0];
						if(name2) {
							msg = words.join(' ');
							sendOnly('[/(private) '+user.alias+': '+msg+'/]', name2);
							sendOnly('[/'+user.alias+' (to '+users[name2].alias+'): '+msg+'/]', name);
						} else {
							sendOnly('Invalid id', name);
						}
					} else {
						msg = words.join(' ').split(/(\\b)/);
						const arr = Object.values(users);
						for(let i = 0; i < msg.length; i += 2) {
							for(const user2 of arr) {
								if(parseInt(msg[i]) != user2.id) continue;
								msg[i] = user2.alias;
								break;
							}
						}
						msg = msg.join('');
						if(['me', 'self', 'action'].includes(cmd)) {
							sendAll('[/ * '+user.alias+' '+msg+'/]');
						} else if(['pat', 'hug', 'poke'].includes(cmd)) {
							sendAll('[/ * '+user.alias+' '+cmd+'s '+msg+'/]');
						} else if(['cookie', 'cupcake', 'donut'].includes(cmd) || /^\\p{Extended_Pictographic}+$/u.test(cmd)) {
							sendAll('[/ * '+user.alias+' gives '+msg+' a '+cmd+'/]');
						} else {
							sendOnly('Invalid command', name);
						}
					}
				} else {
					sendAll(user.alias+': '+msg);
				}
			}`.replace(/^\t\t\t/gm, '');
		const codehistory = [];
		let codeindex = 0;
		let runningcode;
		let lastcode;
		document.body.classList.add('admin');
		persistent = { users:{ [myname]:{ hash:adminhash, admin:true, customname:customname } } };
		get('codebox').oninput = () => {
			const errors = document.getElementsByClassName('error');
			while(errors.length) errors[0].remove();
			if(codeindex < codehistory.length) {
				codehistory.length = ++codeindex;
			}
			lastcode = get('codebox').value;
			get('codebox').classList[get('codebox').value == runningcode? 'remove': 'add']('changed');
		}
		get('codebox').onkeydown = e => {
			setTimeout(() => {
				if(get('codebox').scrollLeft < 7) {
					get('codebox').scrollLeft = 0;
				}
				if(get('codebox').scrollTop < 7) {
					get('codebox').scrollTop = 0;
				}
			});
			if(e.ctrlKey && e.key == 'ArrowUp') {
				codeindex = Math.max(codeindex-1, 0);
				if(get('codebox').value == codehistory[codeindex]) {
					codeindex = Math.max(codeindex-1, 0);
				}
				get('codebox').value = codehistory[codeindex];
			} else if(e.ctrlKey && e.key == 'ArrowDown') {
				codeindex = Math.min(codeindex+1, codehistory.length);
				if(get('codebox').value == codehistory[codeindex]) {
					codeindex = Math.min(codeindex+1, codehistory.length);
				}
				get('codebox').value = codehistory[codeindex] ?? lastcode;
			} else if(e.key == 'Tab') {
				const start = get('codebox').selectionStart;
				const end = get('codebox').selectionEnd;
				const text = get('codebox').value;
				const arr = [text.slice(0, start), text.slice(start, end), text.slice(end)];
				let num = 0;
				if(e.shiftKey) {
					arr[0] = arr[0].replace(/(^|\n)\t(?!.*\n)/, '$1');
					arr[1] = arr[1].replace(/\n\t/g, '\n');
				} else {
					if(arr[1].includes('\n')) {
						arr[0] = arr[0].replace(/(^|\n)(?!.*\n)/, '$1\t');
						arr[1] = arr[1].replace(/\n/g, '\n\t');
					} else {
						arr[1] = '\t';
						num = 1;
					}
				}
				get('codebox').value = arr.join('');
				get('codebox').selectionStart = arr[0].length + num;
				get('codebox').selectionEnd = arr[0].length + arr[1].length;
				lastcode = get('codebox').value;
			} else return;
			e.preventDefault();
			get('codebox').classList[get('codebox').value == runningcode? 'remove': 'add']('changed');
		}
		iframe = document.createElement('iframe');
		iframe.id = 'iframe';
		get('run').onclick = e => {
			e.preventDefault();
			get('codebox').classList.remove('changed');
			runningcode = get('codebox').value;
			if(!iframe.src || codehistory.at(-1) != runningcode) {
				codehistory.push(runningcode);
				codeindex++;
			}
			if(iframe.src) {
				updatesidebar(false);
				socket.emit('sendAll', false);
			}
			iframe.src = 'about:blank';
			document.body.append(iframe);
			iframe.contentWindow.persistent = persistent;
			iframe.contentWindow.kick = (name, msg) => socket.emit('kick', name, msg);
			iframe.contentWindow.ban = (hash, mins, msg) => socket.emit('ban', hash, mins, msg);
			iframe.contentWindow.lock = mins => socket.emit('lock', mins);
			iframe.contentWindow.save = (name, value) => localStorage.setItem(name, JSON.stringify(value));
			iframe.contentWindow.load = name => JSON.parse(localStorage.getItem(name));
			const convert = x => x == undefined || Array.isArray(x)? x: [x];
			iframe.contentWindow.print = (...arr) => {
				if(typeof arr[0] == 'boolean') {
					arr[1] = convert(arr[1]);
					updatesidebar(...arr);
				} else {
					addmsg(arr[0]);
				}
			}
			iframe.contentWindow.sendOnly = (...arr) => {
				if(arr[0] === 1) {
					arr[0] = true;
				} else if(arr[0] === 0) {
					arr[0] = false;
				}
				if(typeof arr[0] == 'boolean') {
					let [add, msg1, names, msg2] = arr;
					if(names == undefined) return;
					msg1 = convert(msg1);
					names = convert(names);
					msg2 = convert(msg2);
					if(names.includes(myname)) {
						updatesidebar(add, msg1);
					} else if(msg2) {
						updatesidebar(add, msg2);
					}
					if(names.some(name => name != myname) || msg2) {
						socket.emit('sendOnly', add, msg1, names, msg2);
					}
				} else {
					let [msg1, names, msg2] = arr;
					if(names == undefined) return;
					if(!msg1 || !names) return;
					names = convert(names);
					if(names.includes(myname)) {
						addmsg(msg1);
					} else if(msg2) {
						addmsg(msg2);
					}
					if(names.some(name => name != myname) || msg2) {
						socket.emit('sendOnly', msg1, names, msg2);
					}
				}
			}
			iframe.contentWindow.sendAll = (...arr) => {
				if(arr[0] === 1) {
					arr[0] = true;
				} else if(arr[0] === 0) {
					arr[0] = false;
				}
				if(typeof arr[0] == 'boolean') {
					let [add, msg1, names, msg2] = arr;
					msg1 = convert(msg1);
					names = convert(names);
					msg2 = convert(msg2);
					if(!names || !names.includes(myname)) {
						updatesidebar(add, msg1);
					} else if(msg2) {
						updatesidebar(add, msg2);
					}
					socket.emit('sendAll', add, msg1, names, msg2);
				} else {
					let [msg1, names, msg2] = arr;
					if(!msg1) return;
					names = convert(names);
					if(!names || !names.includes(myname)) {
						addmsg(msg1);
					} else if(msg2) {
						addmsg(msg2);
					}
					socket.emit('sendAll', msg1, names, msg2);
				}
			}
			for(const event of ['join', 'leave', 'hear']) {
				socket.off(event);
				iframe.contentWindow[event] = () => {};
			}
			socket.on('join', (name, hash, customname) => {
				if(!persistent.users[name]) {
					console.log(hash+'\n'+name+' has joined');
					persistent.users[name] = { hash:hash, customname:customname };
				}
				iframe.contentWindow.join(name, hash, customname);
			});
			socket.on('leave', (msg, name, hash) => {
				console.log(name+' '+msg);
				iframe.contentWindow.leave(msg, name, hash);
				delete persistent.users[name];
			});
			socket.on('hear', (msg, name, hash) => {
				console.log(name+': '+msg);
				iframe.contentWindow.hear(msg, name, hash);
			});
			const adderrormsg = iframe.contentWindow.onerror = onerror = (event, source, line, col) => {
				const arr = runningcode.split('\n');
				let index = col - 1;
				for(let i = 0; i < line - 1; i++) {
					index += arr[i].length + 1; // +1 for the linebreak
				}
				const div = addsysmsg(event+' at '+line+':'+col);
				div.classList.add('error', 'clickable');
				div.onclick = () => {
					get('codebox').selectionStart = get('codebox').selectionEnd = index;
					get('codebox').focus();
				}
				return true;
			}
			iframe.contentWindow.onunhandledrejection = onunhandledrejection = event => {
				const numbers = event.reason.stack.split(/\D+/);
				if(numbers[4] != undefined && numbers[5] != undefined) {
					adderrormsg(event.reason.message, null, numbers[4], numbers[5]);
				} else {
					const div = addsysmsg(event.reason.message);
					div.classList.add('error');
				}
				event.preventDefault();
			}
			iframe.contentWindow.eval(runningcode);
			for(const name in persistent.users) {
				iframe.contentWindow.join(name, persistent.users[name].hash, persistent.users[name].customname);
			}
		}
		get('run').click();
	}
	socket.once('joinroom', join);
	socket.on('log', (...arr) => console.log(...arr));
});
</script>
</body>
</html>