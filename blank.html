<!doctype html>
<html>
<head>
<title>ankabuta/blank</title>
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
@font-face { font-family:'Noto Color Emoji'; font-style:normal; font-weight:400; font-display:swap; size-adjust:120%; unicode-range:U+2139-FE837, U+200D; src:url('NotoColorEmoji.ttf') format('truetype'); }
* { box-sizing:border-box; font-family:'Noto Color Emoji', sans-serif; }
html, body, #top { height:100%; }
body { font-size:8pt; padding:0; margin:0; line-height:13px; }
body.blank * { display:none; }
#top { display:flex; }
#top > div { min-width:200px; overflow:auto scroll; margin-bottom:40px; }
#top > div.closed { opacity:.5; }
#top > div.closed:hover { opacity:1; }
#top input, #top select { pointer-events:none; font-size:8pt; }
h1 { position:sticky; top:0; background:#fff; font-size:8pt; margin:0; padding:0; z-index:1; cursor:default; }
.clickable { cursor:pointer; }
p { white-space:pre-wrap; padding:3px; margin:0; overflow-wrap:break-word; }
p:hover { background:#eee; outline:#ccc solid 1px; }
.rainbow { background:linear-gradient(90deg, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00) 0 0/100px 100px; -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
del { text-decoration:line-through; opacity:.8; }
p:hover del { text-decoration:none; }
.highlight { color:#fff; background:#f00; text-shadow:-1px -1px 1px #000, -1px 0 1px #000, -1px 1px 1px #000, 0 -1px 1px #000, 0 1px 1px #000, 1px -1px 1px #000, 1px 0 1px #000, 1px 1px 1px #000; }
.highlight:hover { background:#700; }
#bottom { position:fixed; bottom:0; min-width:660px; width:100%; text-align:center; font-size:12pt; }
#bottom form { display:inline-block; margin:8px; }
#bottom input[type=number] { width:40px; }
input:focus, select:focus { outline:1px solid #000; outline-offset:-2px; }
input:disabled { opacity:.5; }
@media (prefers-color-scheme:dark) {
	body, h1, input, select { background:#000; color:#fff; }
	p:hover { background:#191919; outline:#333 solid 1px; }
	input, select { border:1px solid #fff; }
	input[type=submit] { background:#222; }
	input:focus, select:focus { outline-color:#ccc; }
	input[type=text]:focus, input[type=number]:focus, select:focus { background:#111; }
	input[type=button]:focus, input[type=submit]:focus { background:#333; }
	::-webkit-scrollbar { width:15px; height:15px; }
	::-webkit-scrollbar-track { background:#222; }
	::-webkit-scrollbar-thumb { background-color:#333; border:1px solid #555; }
	::-webkit-scrollbar-corner { background:#333; }
}
@media (prefers-color-scheme:light) {
	.color { text-shadow:-1px -1px 1px #000, -1px 0 1px #000, -1px 1px 1px #000, 0 -1px 1px #000, 0 1px 1px #000, 1px -1px 1px #000, 1px 0 1px #000, 1px 1px 1px #000; }
}
</style>
</head>
<body class="blank">
<div id="top"></div>
<div id="bottom">
<form id="banform">
<input type="text" id="hash" spellcheck="false">
<input type="number" id="bantime" value="0" min="0">
<input type="submit" value="Ban">
</form>
<form id="regexform">
<input type="text" id="regex" spellcheck="false">
<output id="currentregex"></output>
<input type="submit" value="Regex">
</form>
<form id="lockform">
<input type="number" id="locktime" value="0" min="0">
<input type="submit" value="Lock">
</form>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const get = id => document.getElementById(id);
const reset = () => {
	const elems = document.getElementsByClassName('highlight');
	while(elems.length) {
		elems[0].classList.remove('highlight');
	}
	get('hash').value = get('regex').value = '';
}
const highlighthash = hash => {
	reset();
	const elems = document.getElementsByTagName('p');
	for(let i = 0; i < elems.length; i++) {
		if(!elems[i].classList.contains(hash)) continue;
		elems[i].classList.add('highlight');
	}
	get('hash').value = hash;
}
const highlightregex = regex => {
	reset();
	if(!regex) return;
	const elems = document.getElementsByClassName('room');
	for(let i = 0; i < elems.length; i++) {
		if(!new RegExp(regex).test(elems[i].textContent)) continue;
		elems[i].classList.add('highlight');
	}
	get('regex').value = regex;
}
const login = password => {
	socket.emit('LOGIN', password);
	get('hash').oninput = () => highlighthash(get('hash').value);
	get('regex').oninput = () => highlightregex(get('regex').value);
	get('banform').onsubmit = e => {
		e.preventDefault();
		socket.emit('BAN', get('hash').value, get('bantime').value);
	}
	get('regexform').onsubmit = e => {
		e.preventDefault();
		socket.emit('REGEX', get('regex').value);
	}
	get('lockform').onsubmit = e => {
		e.preventDefault();
		socket.emit('LOCK', get('locktime').value);
	}
}
socket.once('disconnect', () => {
	const inputs = get('bottom').getElementsByTagName('input');
	for(let i = 0; i < inputs.length; i++) {
		inputs[i].disabled = true;
	}
	const div = document.createElement('div');
	div.textContent = 'Connection lost!';
	get('bottom').prepend(div);
	document.title += '☠️';
	socket.disconnect();
});
socket.once('log', (records, regex) => {
	document.body.classList.remove('blank');
	const roomdivs = {};
	const addroom = room => {
		const div = document.createElement('div');
		const h1 = document.createElement('h1');
		h1.textContent = room;
		div.append(h1);
		get('top').append(div);
		roomdivs[room] = div;
		if(room != '(not in a room)') {
			h1.className = 'clickable';
			if(get('regex').value && new RegExp(get('regex').value).test(room)) {
				h1.classList.add('highlight');
			}
			h1.onclick = () => highlightregex(room);
		}
	}
	const addrecord = record => {
		let { room, name, hash, cmd, arr = [], msg, regex } = record;
		const isboolean = typeof arr[0] == 'boolean';
		[room, name, hash, cmd, ...arr] = [room, name, hash, cmd, ...arr].
			map(x => x? JSON.stringify(x).replace(/(?<!\\)"/g, '').replace(/\\"/g, '"'): '');
		const addtext = text => {
			const p = document.createElement('p');
			let html = '';
			const arr = text.split(/\[\{(.*)\}\]/s);
			for(let i = 0; i < arr.length; i++) {
				text = arr[i].replace(/</g, '&lt;').replace(/>/g, '&gt;');
				if(i % 2) {
					html += '<pre>'+text+'</pre>';
				} else {
					let temp;
					do {
						temp = text;
						text = text.
							replace(/\[\[([^\[\[]*?)\]\]/gs, (_, tag) => {
								if(tag.startsWith('select|')) return ('<select><option>'+tag.slice(7).replace(/\|/g, '</option><option>')+'</option></select>').replace(/"/g, '&quot;').replace(/>([^<]*?):([^<]*?)</g, ' value="$1">$2<');
								let style = tag.startsWith('long')? 'width:100px;': tag.startsWith('short')? 'width:20px;': 'width:50px;';
								tag = tag.replace(/^(long|short)/, '');
								if(tag == 'text') return '<input type="'+tag+'" style="'+style+'; max-width:calc(100% - 2px)">';
								if(tag == 'password') return '<input type="'+tag+'" style="'+style+'; max-width:calc(100% - 20px)"><input type="checkbox" title="Show password">';
								if(tag == 'button' || tag == 'submit') return '<input type="'+tag+'" value="send">';
								const match = tag.match(/^(?<tag>\w+):(?<value>.*)/)?.groups;
								if(match) {
									match.value = match.value.replace(/"/g, '&quot;');
									if(match.tag == 'text') return '<input type="'+match.tag+'" placeholder="'+match.value+'" style="'+style+'; max-width:calc(100% - 2px)">';
									if(match.tag == 'password') return '<input type="'+match.tag+'" placeholder="'+match.value+'" style="'+style+'; max-width:calc(100% - 20px)"><input type="checkbox" title="Show password">';
									if(match.tag == 'button' || match.tag == 'submit') return '<input type="'+match.tag+'" value="'+match.value+'">';
									if(match.tag == 'label') return '<label>'+match.value+'</label>';
								}
								return '<form>'+tag+'</form>';
							}).
							replace(/\[\((?:(.*?)\|)?(.*?)\)\]/gs, '<details open><summary>$1</summary>$2</details>').
							replace(/\[!(.*?)!\]/gs, '<span class="rainbow">$1</span>').
							replace(/\[#([0-9a-f]{3})(.*?)#\]/gsi, '<span class="color" style="color:#$1">$2</span>').
							replace(/\[°([0-9a-f]{3})(.*?)°\]/gsi, '<span class="color" style="color:hsl($1, 100%, 50%)">$2</span>').
							replace(/\[\*(.*?)\*\]/gs, '<b>$1</b>').
							replace(/\[\/(.*?)\/\]/gs, '<i>$1</i>').
							replace(/\[_(.*?)_\]/gs, '<span style="text-decoration:underline">$1</span>').
							replace(/\[-(.*?)-\]/gs, '<del>$1</del>').
							replace(/\[&lt;(.*?)&gt;\]/gs, '$1').replace(/\[&gt;(.*?)&lt;\]/gs, '$1');
					} while(temp != text);
					html += text;
				}
			}
			p.innerHTML = html;
			p.title = new Date(record.time).toLocaleTimeString();
			if(!room) room = '(not in a room)';
			if(!roomdivs[room]) addroom(room);
			roomdivs[room].append(p);
			if(hash) {
				p.classList.add(hash, 'clickable');
				if(hash == get('hash').value) {
					p.classList.add('highlight');
				}
				p.onclick = () => highlighthash(hash);
			}
			roomdivs[room].scrollTo({ top:roomdivs[room].scrollHeight, left:0 });
		}
		const boldname = '[*'+name+'*]';
		if(!cmd) {
			if(regex) {
				get('currentregex').textContent = regex;
				msg = 'New regex '+regex;
			}
			addtext(msg);
		} else if(cmd == 'restart') {
			for(const room in roomdivs) {
				roomdivs[room].classList.add('closed');
			}
		} else if(cmd == 'join') {
			addtext(boldname+' has joined');
			roomdivs[room].classList.remove('closed');
		} else if(cmd == 'leave') {
			arr[1] = arr[1]? ' ('+arr[1]+')': '';
			addtext(boldname+' has left'+arr[1]);
			if(arr[0]) {
				roomdivs[room].classList.add('closed');
				roomdivs[room].append(document.createElement('hr'));
				roomdivs[room].scrollTo({ top:roomdivs[room].scrollHeight, left:0 });
			}
		} else if(cmd == 'say') {
			addtext(boldname+': '+arr[0]);
		} else if(cmd == 'sendAll' || cmd == 'sendOnly') {
			let verb = 'says to';
			if(isboolean) verb = ['removes from', 'adds to'][arr.shift()? 1: 0];
			if(!arr[0]) return;
			if((!arr[1] && cmd == 'sendAll') || JSON.stringify(arr[0]) == JSON.stringify(arr[2])) {
				addtext(boldname+' '+verb+' everyone: '+arr[0]);
			} else if(arr[1]) {
				if(cmd == 'sendAll') {
					[arr[0], arr[2]] = [arr[2], arr[0]];
				}
				addtext(boldname+' '+verb+' '+arr[1]+': '+arr[0]+(arr[2]? '\n'+boldname+' '+verb+' everyone else: '+arr[2]: ''));
			}
		} else {
			addtext(boldname+' '+cmd+' '+arr.join(' '));
		}
	}
	for(const record of records) addrecord(record);
	socket.on('log', addrecord);
});
</script>
</body>
</html>