<!doctype html>
<html>
<head>
<title>ankabuta/blank</title>
<meta name="robots" content="noindex">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
@font-face { font-family:'Noto Color Emoji'; font-style:normal; font-weight:400; font-display:swap; size-adjust:120%; unicode-range:U+2139-FE837, U+200D; src:url('NotoColorEmoji.ttf') format('truetype'); }
* { box-sizing:border-box; }
html, body, #top { height:100%; }
body { font-size:7pt; font-family:'Noto Color Emoji', sans-serif; padding:0; margin:0; line-height:13px; }
body.blank * { display:none; }
#top { display:flex; }
#top > div { min-width:200px; overflow:auto scroll; margin-bottom:40px; }
#top > div.closed { opacity:.5; }
#top > div.closed:hover { opacity:1; }
#top input, #top select { pointer-events:none; font-size:7pt; }
#top input[type=text], #top input[type=password] { width:100px; max-width:100%; }
h1 { position:sticky; top:0; background:#fff; font-size:8pt; margin:0; padding:0; z-index:1; cursor:default; }
h1.room, p { cursor:pointer; }
p { white-space:pre-wrap; padding:3px; margin:0; word-wrap:break-word; }
.highlight { color:#fff; background:#f00; text-shadow:1px 1px 1px #000, -1px 1px 1px #000, -1px -1px 1px #000, 1px -1px 1px #000; }
#bottom { position:fixed; bottom:0; min-width:660px; width:100%; text-align:center; }
#bottom form { display:inline-block; margin:8px; }
#bottom input[type=number] { width:40px; }
input:focus, select:focus { outline:1px solid #000; outline-offset:-2px; }
.disconnected { font-size:12pt; margin-bottom:10px; }
@media (prefers-color-scheme:dark) {
	body, h1, input, select { background:#000; color:#fff; }
	input, select { border:1px solid #fff; }
	input[type=submit] { background:#222; }
	input:focus, select:focus { outline-color:#ccc; }
	input[type=text]:focus, input[type=number]:focus, select:focus { background:#111; }
	input[type=button]:focus, input[type=submit]:focus { background:#333; }
	::-webkit-scrollbar { width:15px; height:15px; }
	::-webkit-scrollbar-track { background:#222; }
	::-webkit-scrollbar-thumb { background-color:#333; border:1px solid #555; }
	::-webkit-scrollbar-corner { background:#333; }
}
</style>
</head>
<body class="blank">
<div id="top"></div>
<div id="bottom">
<form id="banform">
<input type="text" id="hash" spellcheck="false">
<input type="number" id="bantime" value="0" min="0">
<input type="submit" value="Ban">
</form>
<form id="regexform">
<input type="text" id="regex" spellcheck="false">
<output id="currentregex"></output>
<input type="submit" value="Regex">
</form>
<form id="lockform">
<input type="number" id="locktime" value="0" min="0">
<input type="submit" value="Lock">
</form>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const get = id => document.getElementById(id);
const reset = () => {
	const elems = document.getElementsByClassName('highlight');
	while(elems.length) {
		elems[0].classList.remove('highlight');
	}
	get('hash').value = get('regex').value = '';
}
const highlighthash = hash => {
	reset();
	const elems = document.getElementsByTagName('p');
	for(let i = 0; i < elems.length; i++) {
		if(!elems[i].classList.contains(hash)) continue;
		elems[i].classList.add('highlight');
	}
	get('hash').value = hash;
}
const highlightregex = regex => {
	reset();
	if(!regex) return;
	const elems = document.getElementsByClassName('room');
	for(let i = 0; i < elems.length; i++) {
		if(!new RegExp(regex).test(elems[i].textContent)) continue;
		elems[i].classList.add('highlight');
	}
	get('regex').value = regex;
}
const login = password => {
	socket.emit('LOGIN', password);
	get('hash').oninput = () => highlighthash(get('hash').value);
	get('regex').oninput = () => highlightregex(get('regex').value);
	get('banform').onsubmit = e => {
		e.preventDefault();
		socket.emit('BAN', get('hash').value, get('bantime').value);
	}
	get('regexform').onsubmit = e => {
		e.preventDefault();
		socket.emit('REGEX', get('regex').value);
	}
	get('lockform').onsubmit = e => {
		e.preventDefault();
		socket.emit('LOCK', get('locktime').value);
	}
}
socket.once('disconnect', () => {
	get('bottom').className = 'disconnected';
	get('bottom').textContent = 'Connection lost!';
});
socket.once('log', (records, regex) => {
	document.body.classList.remove('blank');
	const roomdivs = {};
	const addroom = room => {
		const div = document.createElement('div');
		const h1 = document.createElement('h1');
		h1.textContent = room;
		div.append(h1);
		get('top').append(div);
		roomdivs[room] = div;
		if(room != '(not in a room)') {
			h1.className = 'room';
			if(get('regex').value && new RegExp(get('regex').value).test(room)) {
				h1.classList.add('highlight');
			}
			h1.onclick = () => highlightregex(room);
		}
	}
	const addrecord = record => {
		let { room, name, hash, cmd, arr = [], msg, regex } = record;
		const isboolean = typeof arr[0] == 'boolean';
		[room, name, hash, cmd, ...arr] = [room, name, hash, cmd, ...arr].
			map(x => x? JSON.stringify(x).replace(/(?<!\\)"/g, '').replace(/\\"/g, '"'): '');
		const addtext = (text, bool) => {
			const p = document.createElement('p');
			let html = '';
			const arr = text.split(/\[\{(.*)\}\]/s);
			for(let i = 0; i < arr.length; i++) {
				text = arr[i].replace(/</g, '&lt;').replace(/>/g, '&gt;');
				if(i % 2) {
					html += '<pre>'+text+'</pre>';
				} else {
					let temp;
					do {
						temp = text;
						text = text.
							replace(/\[\[([^\[\[]*?)\]\]/gs, (_, tag) => {
								if(tag.startsWith('select|')) return ('<select><option>'+tag.slice(7).replace(/\|/g, '</option><option>')+'</option></select>').replace(/"/g, '&quot;').replace(/>([^<]*?):([^<]*?)</g, ' value="$1">$2<');
								tag = tag.replace(/^(long)?input/, '$1text');
								if(tag == 'text' || tag == 'password') return '<input type="'+tag+'">';
								if(tag == 'longtext') return '<input type="text" style="width:300px">';
								if(tag == 'button' || tag == 'submit') return '<input type="'+tag+'" value="send">';
								const match = tag.match(/^(?<tag>\w+):(?<value>.*)/)?.groups;
								if(match) {
									match.value = match.value.replace(/"/g, '&quot;');
									if(match.tag == 'text' || match.tag == 'password') return '<input type="'+match.tag+'" placeholder="'+match.value+'">';
									if(match.tag == 'longtext') return '<input type="text" placeholder="'+match.value+'" style="width:300px">';
									if(match.tag == 'button' || match.tag == 'submit') return '<input type="'+match.tag+'" value="'+match.value+'">';
									if(match.tag == 'label') return '<label>'+match.value+'</label>';
								}
								return '<form>'+tag+'</form>';
							}).
							replace(/\[\((?:(.*?)\|)?(.*?)\)\]/gs, '<details open><summary>$1</summary>$2</details>').
							replace(/\[!(.*?)!\]/gs, '<span class="rainbow">$1</span>').
							replace(/\[#([0-9a-f]{3})(.*?)#\]/gsi, '<span style="color:#$1">$2</span>').
							replace(/\[°([0-9a-f]{3})(.*?)°\]/gsi, '<span style="color:hsl($1, 100%, 50%)">$2</span>').
							replace(/\[\*(.*?)\*\]/gs, '<b>$1</b>').
							replace(/\[\/(.*?)\/\]/gs, '<i>$1</i>').
							replace(/\[_(.*?)_\]/gs, '<span style="text-decoration:underline">$1</span>').
							replace(/\[-(.*?)-\]/gs, '<span style="text-decoration:line-through">$1</span>').
							replace(/\[<(.*?)>\]/gs, '$1').replace(/\[>(.*?)<\]/gs, '$1');
					} while(temp != text);
					html += text;
				}
			}
			p.innerHTML = html;
			if(!room) room = '(not in a room)';
			if(!roomdivs[room]) addroom(room);
			roomdivs[room].append(p);
			if(bool) {
				p.className = hash;
				if(hash == get('hash').value) {
					p.classList.add('highlight');
				}
				p.onclick = () => highlighthash(hash);
			}
			roomdivs[room].scrollTo({ top:roomdivs[room].scrollHeight, left:0 });
		}
		const boldname = '[*'+name+'*]';
		if(!cmd) {
			if(regex) {
				get('currentregex').textContent = regex;
				msg = 'New regex '+regex;
			}
			addtext(msg);
		} else if(cmd == 'restart') {
			for(const room in roomdivs) {
				roomdivs[room].classList.add('closed');
			}
		} else if(cmd == 'join') {
			addtext(boldname+' has joined', true);
			if(arr[0]) roomdivs[room].classList.remove('closed');
		} else if(cmd == 'leave') {
			addtext(boldname+' has left', true);
			if(arr[0]) roomdivs[room].classList.add('closed');
		} else if(cmd == 'say') {
			addtext(boldname+': '+arr[0], true);
		} else if(cmd == 'sendAll' || cmd == 'sendOnly') {
			let verb = 'says to';
			if(isboolean) verb = ['removes from', 'adds to'][arr.shift()? 1: 0];
			if(!arr[0]) return;
			let included = arr[1];
			let excluded = 'others';
			if(cmd == 'sendAll') {
				included = arr[1]? 'everyone but '+arr[1]: 'everyone';
				excluded = arr[1];
			}
			if(!included) return;
			let text = boldname+' '+verb+' '+included+': '+arr[0];
			if(arr[2]) {
				text += '\n'+boldname+' '+verb+' '+excluded+': '+arr[2];
			}
			addtext(text, true);
		} else {
			addtext(boldname+' '+cmd+' '+arr.join(' '), true);
		}
	}
	for(const record of records) addrecord(record);
	socket.on('log', addrecord);
});
</script>
</body>
</html>